<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=robots content="all,follow">
<meta name=googlebot content="index,follow,snippet,archive">
<meta name=viewport content="width=device-width,initial-scale=1">
<title>OpenShift Virtualization on vSphere</title>
<meta name=author content="Dale Bewley">
<meta name=keywords content="bewley,guifreelife,openshift,OCP4,virtualization">
<meta name=description content="GUI Free Life">
<meta name=generator content="Hugo 0.91.2">
<link href="//fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,500,700,800" rel=stylesheet type=text/css>
<link rel=stylesheet href=//use.fontawesome.com/releases/v5.11.2/css/all.css>
<link rel=stylesheet href=//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous>
<link href=/css/animate.css rel=stylesheet>
<link href=/css/style.turquoise.css rel=stylesheet id=theme-stylesheet>
<link href=/css/custom.css rel=stylesheet><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]-->
<link rel="shortcut icon" href=/img/favicon.ico type=image/x-icon>
<link rel=apple-touch-icon href=/img/apple-touch-icon.png>
<link href=/css/owl.carousel.css rel=stylesheet>
<link href=/css/owl.theme.css rel=stylesheet>
<link rel=alternate href=http://guifreelife.com/index.xml type=application/rss+xml title="GUI Free Life">
<meta property="og:locale" content="en_us">
<meta property="og:site_name" content="GUI Free Life">
<meta property="og:title" content="OpenShift Virtualization on vSphere">
<meta property="og:type" content="article">
<meta property="og:url" content="http://guifreelife.com/blog/2022/05/13/OpenShift-Virtualization-on-vSphere/">
<meta property="og:description" content="GUI Free Life">
<meta property="og:image" content="http://guifreelife.com/images/shutterstock_2100290518.jpg">
<meta property="og:image:type" content="image/jpg">
<meta property="og:image:width" content="1000">
<meta property="og:image:height" content="667">
<meta property="og:updated_time" content="2022-05-13T00:00:00Z">
<meta property="article:tag" content="openshift">
<meta property="article:tag" content="OCP4">
<meta property="article:tag" content="virtualization">
<meta property="article:published_time" content="2022-05-13T00:00:00Z">
<meta property="article:modified_time" content="2022-05-13T00:00:00Z">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:site content="@dlbewley">
<meta name=twitter:title content="OpenShift Virtualization on vSphere">
<meta name=twitter:image content="http://guifreelife.com/images/shutterstock_2100290518.jpg">
<meta name=twitter:description content="GUI Free Life">
</head>
<body>
<div id=all>
<header class=navbar-affixed-top data-spy=affix data-offset-top=62>
<div class="navbar navbar-default yamm" role=navigation id=navbar>
<div class=container>
<div class=navbar-header>
<a class="navbar-brand home" href=/>
<img src=/img/logo.png alt="OpenShift Virtualization on vSphere logo" class="hidden-xs hidden-sm">
<img src=/img/logo-small.png alt="OpenShift Virtualization on vSphere logo" class="visible-xs visible-sm">
<span class=sr-only>OpenShift Virtualization on vSphere - go to homepage</span>
</a>
<div class=navbar-buttons>
<button type=button class="navbar-toggle btn-template-main" data-toggle=collapse data-target=#navigation>
<span class=sr-only>Toggle Navigation</span>
<i class="fas fa-align-justify"></i>
</button>
</div>
</div>
<div class="navbar-collapse collapse" id=navigation>
<ul class="nav navbar-nav navbar-right">
<li class=dropdown>
<a href=/>Home</a>
</li>
<li class="dropdown active">
<a href=/blog/>Blog</a>
</li>
<li class=dropdown>
<a href=/contact/>Contact</a>
</li>
</ul>
</div>
<div class="collapse clearfix" id=search>
<form class=navbar-form role=search>
<div class=input-group>
<input type=text class=form-control placeholder=Search>
<span class=input-group-btn>
<button type=submit class="btn btn-template-main"><i class="fas fa-search"></i></button>
</span>
</div>
</form>
</div>
</div>
</div>
</header>
<style>.bar.background-image-fixed-banner{background:url(/images/shutterstock_2100290518.jpg)50% 0 no-repeat;background-attachment:fixed;background-size:cover;padding:100px 5%;text-shadow:2px 3px 4px var(--primary-accent),0 0 1em var(--navbar-border-top)}</style>
<div>
<div class=container>
<div class=row>
<div class=col-md-12>
<section class="bar background-image-fixed-banner heading h2 color-white text-center">
<h1>OpenShift Virtualization on vSphere</h1>
</section>
</div>
</div>
</div>
</div>
<div id=content>
<div class=container>
<div class=row>
<div class=col-md-9 id=blog-post>
<p class="text-muted text-uppercase mb-small text-right">
May 13, 2022
</p>
<div id=post-content>
<p>OpenShift Virtualization builds upon <a href=https://kubevirt.io title=KubeVirt.io>KubeVirt</a> to provide a container native home for your virtual machine workloads. While bare metal is the only officially support platform today, this post will walk through enabling OpenShift Virtualization on vSphere in a lab environment. With nested virtualization you&rsquo;ll be able to spin up containerized VMs bridged to your physical networks.</p>
<h1 id=understanding-openshift-virtualization>Understanding OpenShift Virtualization</h1>
<p>Why virtual machines in containers?!</p>
<p>As you begin to migrate applications to a containerized, cloud-native platform like OpenShift you begin to realize benefits like portability, repeatability, and automation. Applications hosted on virtual machines may not be practical to containerize or even compatible.</p>
<p>OpenShift Virtualization enables you to run your virtualized workloads on the same platform powering your containerized workloads using a consistent Kubernetes interface.</p>
<p>To experiment with container native virtualization on vSphere let&rsquo;s begin by enabling a suitable network configuration.</p>
<h1 id=configuring-vsphere-networking-for-kubevirt>Configuring vSphere Networking for KubeVirt</h1>
<p>Virtual machines will attach to the pod network by default. You likely already have several networks plumbed to your ESXi Hosts, and it&rsquo;s likely you may want to attach your containerized virtual machines to these same networks. Virtual Switch Tagging (VST) and Virtual Guest Tagging (VGT) provide the ability to carry a VLAN tag all the way from the physical rack switch through the vSwitch to a guest.</p>
<h2 id=adding-a-portgroup-to-vswitch>Adding a PortGroup to vSwitch</h2>
<p>Follow the <a href=https://kb.vmware.com/s/article/1003806 title="VLAN configuration on virtual switches, physical switches, and virtual machines (1003806)">VMware documentation</a> to configure your standard or distributed vSwitch by adding a PortGroup to carry all the VLANs you would like to be present in the OpenShift Virtualization environment.
Configure the portgroup to have vlan type <em>&ldquo;VLAN trunking&rdquo;</em> and specify the appropriate VLANs. For a standard vSwitch select 4095 to carry all. For a distributed vSwitch select 0-4094.</p>
<blockquote>
<p><strong>‚ö†Ô∏è IMPORTANT</strong> Enable promiscuous mode</p>
<p>Switches improve network efficiency by learning where MAC addresses are and not sending traffic where it isn&rsquo;t needed. Because our virtual machines will be using MAC addresses that vSphere does not know about you will see failures such as no response to DHCP or ARP requests unless you <a href=https://kb.vmware.com/s/article/1002934 title="How promiscuous mode works at the virtual switch and portgroup levels (1002934)">modify the security settings of the network or PortGroup</a>.</p>
</blockquote>
<figure><a href=/images/cnv-trunk-1.png><img src=/images/cnv-trunk-1.png alt="Trunk Port Group for Standard vSwitch" width=100%></a><figcaption>
<p>Trunk Port Group for Standard vSwitch</p>
</figcaption>
</figure>
<blockquote>
<span class=expand>
<span class=expand-label style=cursor:pointer onclick="$h=$(this),$h.next('div').slideToggle(200,function(){$h.children('i').attr('class',function(){return $h.next('div').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right'})})">
Distributed vSwitch Option
<i class="fas fa-chevron-right"></i>
</span>
<div class=expand-content style="display:none;margin:10px 0">
<figure><a href=/images/cnv-trunkpg-1.png><img src=/images/cnv-trunkpg-1.png alt="Example of Port Group for a Distributed vSwitch" width=100%></a><figcaption>
<p>Example of Port Group for a Distributed vSwitch</p>
</figcaption>
</figure>
</div>
</span>
</blockquote>
<p><strong>Why did we do that?</strong></p>
<p>Now we can create guests for our OpenShift nodes which have a 2nd network interface card. When this NIC is attached to the newly created <em>&ldquo;Trunk&rdquo;</em> port group it will receive an an 802.1Q trunk from the vSwitch. The VLANs on that trunk may then be split back out to bridges in the node which provide connectivity to containerized virtual machines.</p>
<h1 id=customizing-the-openshift-rhcos-node-template>Customizing the OpenShift RHCOS Node Template</h1>
<p>First, let&rsquo;s restate what we are going to achieve: <em>A virtual machine in a container on a virtual machine on a physical ESXi host.</em> For this to work, our Guest (OpenShift Node) running in vSphere needs to know how to &ldquo;do virtualization&rdquo;.</p>
<p>Things are beginning to feel a bit recursive. üòµ
Don&rsquo;t worry. We&rsquo;ll get there.</p>
<p>It all starts with a template&mldr;</p>
<h2 id=cloning-the-existing-rhcos-template-as-a-vm>Cloning the Existing RHCOS Template as a VM</h2>
<p>The <a href=https://github.com/openshift/machine-api-operator title="Machine API Operator">OpenShift Machine API operator</a> builds nodes in vSphere by cloning a guest template that was created during cluster installation. This template does not include settings required for nested virtualization.</p>
<p>Clone the &ldquo;<em>*rhcos</em>&rdquo; template to a virtual machine so that it is possible to make edits. Give the VM a name that matches the template with &ldquo;<em>-cnv</em>&rdquo; on the end. So <em>&ldquo;hub-7vxwj-rhcos&rdquo;</em> becomes <em>&ldquo;hub-7vxwj-rhcos-cnv&rdquo;</em>.</p>
<blockquote>
<p>üìì We are using &ldquo;cnv&rdquo; as shorthand for Container Native Virtualization which predates the OpenShift Virtualization name.</p>
</blockquote>
<h2 id=customizing-the-temporary-vm>Customizing the Temporary VM</h2>
<p>This VM is temporary. Don&rsquo;t boot it. We just want to use it to make some changes that aren&rsquo;t possible to make on a static template.</p>
<p><strong>Make These Changes</strong></p>
<ul>
<li>Enable these CPU features: Hardware virtualization, IOMMU, Performance counters</li>
<li>Add a 2nd NIC attached to the <code>Trunk</code> portgroup</li>
</ul>
<figure><a href=/images/cnv-cpu-1.png><img src=/images/cnv-cpu-1.png alt="CNV Node Template with Customizations" width=100%></a><figcaption>
<p>CNV Node Template with Customizations</p>
</figcaption>
</figure>
<h2 id=converting-the-customized-vm-to-a-template>Converting the Customized VM to a Template</h2>
<p>Once these changes have been made, convert this VM to a template. Keep the same <code>hub-7vxwj-rhcos-cnv</code> name.</p>
<h1 id=creating-a-machineset-for-hypervisors>Creating a Machineset for Hypervisors</h1>
<p><strong>How do we tell OpenShift to use this template?</strong></p>
<p><a href=https://docs.openshift.com/container-platform/4.10/rest_api/machine_apis/machineset-machine-openshift-io-v1beta1.html title="MachineSet API">MachineSets</a> define how many machines to provision as worker nodes and exactly how to build them.</p>
<p>Based on the existing worker machineset, create a new one that is CNV specific. This machineset will use the newly created template.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># copy existing worker machineset</span>
INFRA_ID<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>oc get infrastructure/cluster -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{.status.infrastructureName}&#39;</span><span style=color:#66d9ef>)</span>
echo $INFRA_ID
hub-7vxwj
oc get machineset/<span style=color:#e6db74>${</span>INFRA_ID<span style=color:#e6db74>}</span>-worker -n openshift-machine-api -o yaml &gt; <span style=color:#e6db74>${</span>INFRA_ID<span style=color:#e6db74>}</span>-cnv.yaml
<span style=color:#75715e># modify to look like the example below and create it</span>
vi <span style=color:#e6db74>${</span>INFRA_ID<span style=color:#e6db74>}</span>-cnv.yaml
oc create -f <span style=color:#e6db74>${</span>INFRA_ID<span style=color:#e6db74>}</span>-cnv.yaml -n openshift-machine-api
</code></pre></div><blockquote>
<p>üìì <strong><code>MachineSet</code> For Workers With Virtualization</strong></p>
<p>Notice that line 42 refers to the <code>Trunk</code> port group and line 46 refers to the virtual machine template <code>hub-7vxwj-rhcos-cnv</code> created above.</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>machine.openshift.io/v1beta1</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>MachineSet</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:#f92672>metadata</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>  <span style=color:#f92672>annotations</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span>    <span style=color:#f92672>machine.openshift.io/memoryMb</span>: <span style=color:#e6db74>&#34;16384&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>    <span style=color:#f92672>machine.openshift.io/vCPU</span>: <span style=color:#e6db74>&#34;6&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>  <span style=color:#f92672>labels</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>    <span style=color:#f92672>machine.openshift.io/cluster-api-cluster</span>: <span style=color:#ae81ff>hub-7vxwj</span>
<span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>hub-7vxwj-cnv</span>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>openshift-machine-api</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>  <span style=color:#f92672>resourceVersion</span>: <span style=color:#e6db74>&#34;162348847&#34;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span style=color:#f92672>spec</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span>  <span style=color:#f92672>selector</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span>    <span style=color:#f92672>matchLabels</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span>      <span style=color:#f92672>machine.openshift.io/cluster-api-cluster</span>: <span style=color:#ae81ff>hub-7vxwj</span>
<span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span>      <span style=color:#f92672>machine.openshift.io/cluster-api-machineset</span>: <span style=color:#ae81ff>hub-7vxwj-cnv</span>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span>  <span style=color:#f92672>template</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span>    <span style=color:#f92672>metadata</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span>      <span style=color:#f92672>labels</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span>        <span style=color:#f92672>machine.openshift.io/cluster-api-cluster</span>: <span style=color:#ae81ff>hub-7vxwj</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span>        <span style=color:#f92672>machine.openshift.io/cluster-api-machine-role</span>: <span style=color:#ae81ff>worker</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span>        <span style=color:#f92672>machine.openshift.io/cluster-api-machine-type</span>: <span style=color:#ae81ff>worker</span>
<span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span>        <span style=color:#f92672>machine.openshift.io/cluster-api-machineset</span>: <span style=color:#ae81ff>hub-7vxwj-cnv</span>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span>    <span style=color:#f92672>spec</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span>      <span style=color:#f92672>metadata</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span>        <span style=color:#f92672>labels</span>:
<span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span>          <span style=color:#f92672>machine.openshift.io/cluster-api-machineset</span>: <span style=color:#ae81ff>hub-7vxwj-cnv</span>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span>      <span style=color:#f92672>providerSpec</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span>        <span style=color:#f92672>value</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span>          <span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>vsphereprovider.openshift.io/v1beta1</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span>          <span style=color:#f92672>credentialsSecret</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span>            <span style=color:#f92672>name</span>: <span style=color:#ae81ff>vsphere-cloud-credentials</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span>          <span style=color:#f92672>diskGiB</span>: <span style=color:#ae81ff>90</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span>          <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VSphereMachineProviderSpec</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span>          <span style=color:#f92672>memoryMiB</span>: <span style=color:#ae81ff>16384</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span>          <span style=color:#f92672>metadata</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span>            <span style=color:#f92672>creationTimestamp</span>: <span style=color:#66d9ef>null</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span>          <span style=color:#f92672>network</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span>            <span style=color:#f92672>devices</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span>            - <span style=color:#f92672>networkName</span>: <span style=color:#ae81ff>lab-192-168-4-0-b24</span>
<span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span>            - <span style=color:#f92672>networkName</span>: <span style=color:#ae81ff>Trunk</span>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span>          <span style=color:#f92672>numCPUs</span>: <span style=color:#ae81ff>6</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span>          <span style=color:#f92672>numCoresPerSocket</span>: <span style=color:#ae81ff>1</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span>          <span style=color:#f92672>snapshot</span>: <span style=color:#e6db74>&#34;&#34;</span>
<span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span>          <span style=color:#f92672>template</span>: <span style=color:#ae81ff>hub-7vxwj-rhcos-cnv</span>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span>          <span style=color:#f92672>userDataSecret</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span>            <span style=color:#f92672>name</span>: <span style=color:#ae81ff>worker-user-data</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span>          <span style=color:#f92672>workspace</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span>            <span style=color:#f92672>datacenter</span>: <span style=color:#ae81ff>Garden</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span>            <span style=color:#f92672>datastore</span>: <span style=color:#ae81ff>VMData-HD</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span>            <span style=color:#f92672>folder</span>: <span style=color:#ae81ff>/Garden/vm/hub-7vxwj</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span>            <span style=color:#f92672>resourcePool</span>: <span style=color:#ae81ff>/Garden/host/Goat/Resources</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span>            <span style=color:#f92672>server</span>: <span style=color:#ae81ff>vcenter.lab.bewley.net</span>
</code></pre></div><h1 id=configuring-openshift-virtualization-networking>Configuring OpenShift Virtualization Networking</h1>
<p><strong>Install OpenShift Virtualization</strong> using the web UI or GitOps and <a href=https://github.com/redhat-cop/gitops-catalog/tree/main/virtualization-operator>this repo</a>.</p>
<p>Once installed and a <code>Hyperconverged</code> resource has been created, the <em>nmstate.io</em> API group will become available.</p>
<blockquote>
<p>üìì <strong><a href=https://nmstate.io/ title="NMState A Declarative API for Host Network Management">nmstate.io</a> API Group Resources</strong> for node network configuration</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ oc api-resources --api-group nmstate.io
NAME                                 SHORTNAMES   APIVERSION           NAMESPACED   KIND
nodenetworkconfigurationenactments   nnce         nmstate.io/v1beta1   false        NodeNetworkConfigurationEnactment
nodenetworkconfigurationpolicies     nncp         nmstate.io/v1beta1   false        NodeNetworkConfigurationPolicy
nodenetworkstates                    nns          nmstate.io/v1beta1   false        NodeNetworkState
</code></pre></div><h2 id=creating-a-node-network-configuration-policy>Creating a Node Network Configuration Policy</h2>
<p>If we want to use all the VLANs we are trunking to a node, we need to tell OpenShift how to configure NIC for all those networks.
Using resources from the <a href=https://nmstate.io/ title="NMState A Declarative API for Host Network Management">NMState API</a> we can configure the networking in the node operating system.</p>
<p>Create a <code>NodeNetworkConfigurationPolicy</code> that will be used to configure the 2nd NIC for us in a way that will present each VLAN as a bridge.</p>
<p>You may optionally log in to the node using <code>oc debug node</code> or ssh, and look at the current network settings before making changes.</p>
<p>Notice in this case that the 2nd NIC <em>ens224</em> exists, but it has no useful configuration.</p>
<figure><a href=/images/cnv-nncp-1.png><img src=/images/cnv-nncp-1.png alt="Node Network before NNCP" width=100%></a><figcaption>
<p>Node Network before NNCP</p>
</figcaption>
</figure>
<blockquote>
<p>üìì <strong><code>NodeNetworkConfigurationPolicy</code> For Workers With Virtualization</strong></p>
<p>Notice on line 7 we are checking for a label that is common to the nodes with virtualization support. This will ensure our NNCP is applied only to the appropriate nodes.</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>nmstate.io/v1beta1</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>NodeNetworkConfigurationPolicy</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span style=color:#f92672>metadata</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ens224-policy</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span style=color:#f92672>spec</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span>  <span style=color:#f92672>nodeSelector</span>:
<span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span>    <span style=color:#f92672>machine.openshift.io/cluster-api-machineset</span>: <span style=color:#ae81ff>hub-7vxwj-cnv</span>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span>  <span style=color:#f92672>desiredState</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span>    <span style=color:#f92672>interfaces</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span>      <span style=color:#75715e># defined only to facilitate disabling DHCP</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ens224</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span>        <span style=color:#f92672>type</span>: <span style=color:#ae81ff>ethernet</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>up</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span>        <span style=color:#f92672>ipv4</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span>          <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span>        <span style=color:#f92672>ipv6</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span>          <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span>      <span style=color:#75715e># trans proxy</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ens224.1925</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span>        <span style=color:#f92672>type</span>: <span style=color:#ae81ff>vlan</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>up</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span>        <span style=color:#f92672>vlan</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span>          <span style=color:#f92672>base-iface</span>: <span style=color:#ae81ff>ens224</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span>          <span style=color:#f92672>id</span>: <span style=color:#ae81ff>1925</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span>        <span style=color:#f92672>ipv4</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span>          <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span>        <span style=color:#f92672>ipv6</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span>          <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>br-1925</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span>        <span style=color:#f92672>type</span>: <span style=color:#ae81ff>linux-bridge</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>up</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span>        <span style=color:#f92672>ipv4</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span>          <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span>        <span style=color:#f92672>ipv6</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span>          <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span>        <span style=color:#f92672>bridge</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span>          <span style=color:#f92672>options</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span>            <span style=color:#f92672>stp</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span>              <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span>          <span style=color:#f92672>port</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ens224.1925</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span>            <span style=color:#f92672>vlan</span>: {}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span>      <span style=color:#75715e># disco</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ens224.1926</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span>        <span style=color:#f92672>type</span>: <span style=color:#ae81ff>vlan</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>up</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span>        <span style=color:#f92672>vlan</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span>          <span style=color:#f92672>base-iface</span>: <span style=color:#ae81ff>ens224</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span>          <span style=color:#f92672>id</span>: <span style=color:#ae81ff>1926</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span>        <span style=color:#f92672>ipv4</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span>          <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span>        <span style=color:#f92672>ipv6</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span>          <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>br-1926</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span>        <span style=color:#f92672>type</span>: <span style=color:#ae81ff>linux-bridge</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>up</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span>        <span style=color:#f92672>ipv4</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span>          <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span>        <span style=color:#f92672>ipv6</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span>          <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span>        <span style=color:#f92672>bridge</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span>          <span style=color:#f92672>options</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span>            <span style=color:#f92672>stp</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span>              <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span>          <span style=color:#f92672>port</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ens224.1926</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span>            <span style=color:#f92672>vlan</span>: {}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span>      <span style=color:#75715e># metal</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ens224.1927</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span>        <span style=color:#f92672>type</span>: <span style=color:#ae81ff>vlan</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>up</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span>        <span style=color:#f92672>vlan</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span>          <span style=color:#f92672>base-iface</span>: <span style=color:#ae81ff>ens224</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span>          <span style=color:#f92672>id</span>: <span style=color:#ae81ff>1927</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span>        <span style=color:#f92672>ipv4</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span>          <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span>        <span style=color:#f92672>ipv6</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span>          <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>br-1927</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span>        <span style=color:#f92672>type</span>: <span style=color:#ae81ff>linux-bridge</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>up</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span>        <span style=color:#f92672>ipv4</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span>          <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span>        <span style=color:#f92672>ipv6</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span>          <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span>        <span style=color:#f92672>bridge</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span>          <span style=color:#f92672>options</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span>            <span style=color:#f92672>stp</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span>              <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span>          <span style=color:#f92672>port</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ens224.1927</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span>            <span style=color:#f92672>vlan</span>: {}
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span>      <span style=color:#75715e># provisioning</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ens224.1928</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span>        <span style=color:#f92672>type</span>: <span style=color:#ae81ff>vlan</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>up</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span>        <span style=color:#f92672>vlan</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">103</span>          <span style=color:#f92672>base-iface</span>: <span style=color:#ae81ff>ens224</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">104</span>          <span style=color:#f92672>id</span>: <span style=color:#ae81ff>1928</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">105</span>        <span style=color:#f92672>ipv4</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">106</span>          <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">107</span>        <span style=color:#f92672>ipv6</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">108</span>          <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>br-1928</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span>        <span style=color:#f92672>type</span>: <span style=color:#ae81ff>linux-bridge</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>up</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">112</span>        <span style=color:#f92672>ipv4</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">113</span>          <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">114</span>        <span style=color:#f92672>ipv6</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">115</span>          <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">116</span>        <span style=color:#f92672>bridge</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">117</span>          <span style=color:#f92672>options</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">118</span>            <span style=color:#f92672>stp</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">119</span>              <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>false</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">120</span>          <span style=color:#f92672>port</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">121</span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>ens224.1928</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">122</span>            <span style=color:#f92672>vlan</span>: {}
</code></pre></div><blockquote>
<p>‚ö†Ô∏è <strong>Ambiguous Kubevirt Labels</strong></p>
<p>Ideally, we could rely on a label like <em>kubevirt.io/scheduleable: &ldquo;true&rdquo;</em>, but in my experience that label is not unique to hosts having virtualization extensions. I have opened a bug to find out more. <a href="https://bugzilla.redhat.com/show_bug.cgi?id=2081133">https://bugzilla.redhat.com/show_bug.cgi?id=2081133</a></p>
</blockquote>
<h2 id=confirming-node-networking-configuration-changes>Confirming Node Networking Configuration Changes</h2>
<p>After creation of the NodeNetworkConfigurationPolicy, a <code>NodeNetworkConfigurationEnablement</code> will be created for each node that satisfies the node selector in the policy. (<em>machine.openshift.io/cluster-api-machineset: hub-7vxwj-cnv</em>)</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ oc get nodes -l machine.openshift.io/cluster-api-machineset<span style=color:#f92672>=</span>hub-7vxwj-cnv
NAME                  STATUS   ROLES    AGE    VERSION
hub-7vxwj-cnv-drhkz   Ready    worker   162m   v1.23.5+9ce5071

$ oc create -f nodenetworkconfigurationpolicy.yaml
nodenetworkconfigurationpolicy.nmstate.io/ens224-policy created

$ oc get nnce
NAME                                STATUS
hub-7vxwj-cnv-drhkz.ens224-policy   Available
</code></pre></div><p>Now that the NNCE is status <code>Available</code>, optionally log back into the node and take a look at the network configuration.</p>
<p>Woah! Look at all those interfaces on <em>ens224</em>!</p>
<figure><a href=/images/cnv-nncp-2.png><img src=/images/cnv-nncp-2.png alt="Node Network after NNCE" width=100%></a><figcaption>
<p>Node Network after NNCE</p>
</figcaption>
</figure>
<blockquote>
<p>üìì <strong>Node Network Debugging</strong></p>
<p>See <a href=https://docs.openshift.com/container-platform/4.10/virt/node_network/virt-observing-node-network-state.html title="Observing Node Network State">Observing node network state</a></p>
</blockquote>
<h1 id=attaching-a-containerized-virtual-machine-to-a-vlan>Attaching a Containerized Virtual Machine to a VLAN</h1>
<p>All the work above occurred at the cluster level by a cluster admin. Further configuration takes place within the namespaces that host the virtual machines.</p>
<h2 id=configuring-openshift-namespace-networking-for-vms>Configuring OpenShift Namespace Networking for VMs</h2>
<p>For developers to attach CNV virtual machines to the networks plumbed above, we need to create points of attachment in the namespaces they are privileged to.</p>
<p>The <code>NetworkAttachmentDefinition</code> resource provides virtual machines a logical reference to the network interfaces we created previously.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ oc api-resources --api-group k8s.cni.cncf.io
NAME                             SHORTNAMES       APIVERSION           NAMESPACED   KIND
network-attachment-definitions   net-attach-def   k8s.cni.cncf.io/v1   true         NetworkAttachmentDefinition

$ oc explain network-attachment-definition
KIND:     NetworkAttachmentDefinition
VERSION:  k8s.cni.cncf.io/v1

DESCRIPTION:
     NetworkAttachmentDefinition is a CRD schema specified by the Network
     Plumbing Working Group to express the intent <span style=color:#66d9ef>for</span> attaching pods to one or
     more logical or physical networks. More information available at:
     https://github.com/k8snetworkplumbingwg/multi-net-spec
</code></pre></div><blockquote>
<p>üìì <strong><code>NetworkAttachmentDefinition</code></strong> Enabling access to <em>provisioning</em> bridge.</p>
<p>Enables VMs in a namespace to attach to a network using CNI.</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>k8s.cni.cncf.io/v1</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>NetworkAttachmentDefinition</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:#f92672>metadata</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>  <span style=color:#f92672>annotations</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span>    <span style=color:#f92672>description</span>: <span style=color:#ae81ff>Provisioning Bridge V1928</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>    <span style=color:#f92672>k8s.v1.cni.cncf.io/resourceName</span>: <span style=color:#ae81ff>bridge.network.kubevirt.io/br-1928</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>vlan-1928</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>provisioning</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span style=color:#f92672>spec</span>:
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span>  <span style=color:#f92672>config</span>: |-<span style=color:#e6db74>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span style=color:#e6db74>    {
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span style=color:#e6db74>      &#34;name&#34;: &#34;vlan-1928&#34;,
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span style=color:#e6db74>      &#34;cniVersion&#34;: &#34;0.3.1&#34;,
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span style=color:#e6db74>      &#34;plugins&#34;: [
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span style=color:#e6db74>        {
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span style=color:#e6db74>          &#34;type&#34;: &#34;cnv-bridge&#34;,
</span><span style=display:block;width:100%;background-color:#3c3d38><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span style=color:#e6db74>          &#34;bridge&#34;:&#34;br-1928&#34;,
</span></span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span style=color:#e6db74>          &#34;vlan&#34;:1928,
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span style=color:#e6db74>          &#34;ipam&#34;:{}
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span style=color:#e6db74>        },
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span style=color:#e6db74>        {
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span style=color:#e6db74>          &#34;type&#34;: &#34;cnv-tuning&#34;
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span style=color:#e6db74>        }
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span style=color:#e6db74>      ]
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span style=color:#e6db74>    }</span>    
</code></pre></div><p>Let&rsquo;s create an attachment to the provisioning network on bridge br-1928.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ oc new-project provisioning
$ oc create -f net-attach-def.yaml -n provisioning

$ oc get net-attach-def -n provisioning
NAME        AGE
vlan-1928   1m
</code></pre></div><p>Once the network attachment definition is available, a VM can be launch using this network on a bridged interface.</p>
<h1 id=creating-a-containerized-vm>Creating a Containerized VM</h1>
<p>I&rsquo;ll leave the details of creating and using VMs in OpenShift for another time, but I will complete the example.</p>
<p>Create a virtual machine in the OpenShift console, and customize the VM by adding a 2nd NIC. Select the <code>vlan-1928</code> network attachment definition created above.</p>
<blockquote>
<p>üìì <strong>Select The Proper Namespace</strong></p>
<p>Remember that network attachment definitions are namespace scoped, as are VMs. Select the <em>provisioning</em> namespace when creating the virtual machine.</p>
</blockquote>
<figure><a href=/images/cnv-vm-1.png><img src=/images/cnv-vm-1.png alt="VM Dialog: Add 2nd NIC" width=100%></a><figcaption>
<p>VM Dialog: Add 2nd NIC</p>
</figcaption>
</figure>
<p>After booting and logging into the VM, it can be seen that the eth1 NIC obtained an IP address from the DHCP server on the provisioning LAN.</p>
<figure><a href=/images/cnv-vm-2.png><img src=/images/cnv-vm-2.png alt="VM console showing eth1 Provisioning LAN" width=100%></a><figcaption>
<p>VM console showing eth1 Provisioning LAN</p>
</figcaption>
</figure>
<h1 id=summary>Summary</h1>
<p>Having enabled CPU virtualization extensions on the virtual machine template and adding trunk support to the vswitch you can now launch virtual machines in your OpenShift cluster on vSphere with access to your lab networks.</p>
<p>This is a great way to <a href=https://docs.openshift.com/container-platform/4.10/virt/about-virt.html title="About OpenShift virtualization">explore OpenShift Virtualization</a> and experiment with its features as you architect a production use case that leverages bare-metal nodes at a greater scale.</p>
<p>Have fun!</p>
<h1 id=references>References</h1>
<ul>
<li><a href=https://docs.openshift.com/container-platform/4.10/virt/about-virt.html title="About OpenShift virtualization">About OpenShift Virtualization</a></li>
<li><a href=https://kubevirt.io title=KubeVirt.io>KubeVirt.io</a></li>
<li><a href=https://nmstate.io/ title="NMState A Declarative API for Host Network Management">NMState.io</a></li>
<li><a href=https://github.com/openshift/machine-api-operator title="Machine API Operator">Machine API Operator</a></li>
<li><a href=https://docs.openshift.com/container-platform/4.10/rest_api/machine_apis/machineset-machine-openshift-io-v1beta1.html title="MachineSet API">MachineSet API</a></li>
<li><a href=https://access.redhat.com/solutions/6692341 title="Enabling Nested Virtualization on KVM Hypervisors">Enabling CNV Nested Virtualization on KVM Hypervisors</a> is Tech Preview</li>
</ul>
</div>
<div id=comments>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//dlbewleygithubio.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
</div>
<div class=col-md-3>
<div class="panel panel-default sidebar-menu">
<div class=panel-heading>
<h3 class=panel-title>Search</h3>
</div>
<div class=panel-body>
<form action=//google.com/search method=get accept-charset=utf-8 role=search>
<div class=input-group>
<input type=search name=q class=form-control placeholder=Search>
<input type=hidden name=sitesearch value=http://guifreelife.com/>
<span class=input-group-btn>
<button type=submit class="btn btn-template-main"><i class="fas fa-search"></i></button>
</span>
</div>
</form>
</div>
</div>
<div class="panel sidebar-menu">
<div class=panel-heading>
<h3 class=panel-title>Tagged</h3>
</div>
<div class=panel-body>
<ul class=tag-cloud>
<li class=active>
<a href=/tags/openshift><i class="fas fa-tags"></i> openshift</a>
</li>
<li class=active>
<a href=/tags/OCP4><i class="fas fa-tags"></i> OCP4</a>
</li>
<li class=active>
<a href=/tags/virtualization><i class="fas fa-tags"></i> virtualization</a>
</li>
</ul>
</div>
</div>
<div class="panel sidebar-menu">
<div class=panel-heading>
<h3 class=panel-title>TOC</h3>
</div>
<div class=panel-body>
<nav id=TableOfContents>
<ul>
<li><a href=#understanding-openshift-virtualization>Understanding OpenShift Virtualization</a></li>
<li><a href=#configuring-vsphere-networking-for-kubevirt>Configuring vSphere Networking for KubeVirt</a>
<ul>
<li><a href=#adding-a-portgroup-to-vswitch>Adding a PortGroup to vSwitch</a></li>
</ul>
</li>
<li><a href=#customizing-the-openshift-rhcos-node-template>Customizing the OpenShift RHCOS Node Template</a>
<ul>
<li><a href=#cloning-the-existing-rhcos-template-as-a-vm>Cloning the Existing RHCOS Template as a VM</a></li>
<li><a href=#customizing-the-temporary-vm>Customizing the Temporary VM</a></li>
<li><a href=#converting-the-customized-vm-to-a-template>Converting the Customized VM to a Template</a></li>
</ul>
</li>
<li><a href=#creating-a-machineset-for-hypervisors>Creating a Machineset for Hypervisors</a></li>
<li><a href=#configuring-openshift-virtualization-networking>Configuring OpenShift Virtualization Networking</a>
<ul>
<li><a href=#creating-a-node-network-configuration-policy>Creating a Node Network Configuration Policy</a></li>
<li><a href=#confirming-node-networking-configuration-changes>Confirming Node Networking Configuration Changes</a></li>
</ul>
</li>
<li><a href=#attaching-a-containerized-virtual-machine-to-a-vlan>Attaching a Containerized Virtual Machine to a VLAN</a>
<ul>
<li><a href=#configuring-openshift-namespace-networking-for-vms>Configuring OpenShift Namespace Networking for VMs</a></li>
</ul>
</li>
<li><a href=#creating-a-containerized-vm>Creating a Containerized VM</a></li>
<li><a href=#summary>Summary</a></li>
<li><a href=#references>References</a></li>
</ul>
</nav>
</div>
</div>
<div class="panel sidebar-menu">
<div class=panel-heading>
<h3 class=panel-title>Tags</h3>
</div>
<div class=panel-body>
<ul class=tag-cloud>
<li>
<a href=/tags/AWS><i class="fas fa-tags"></i> AWS</a>
</li>
<li>
<a href=/tags/CDK><i class="fas fa-tags"></i> CDK</a>
</li>
<li>
<a href=/tags/OCP3><i class="fas fa-tags"></i> OCP3</a>
</li>
<li>
<a href=/tags/OCP4><i class="fas fa-tags"></i> OCP4</a>
</li>
<li>
<a href=/tags/RHACM><i class="fas fa-tags"></i> RHACM</a>
</li>
<li>
<a href=/tags/RHEL><i class="fas fa-tags"></i> RHEL</a>
</li>
<li>
<a href=/tags/ansible><i class="fas fa-tags"></i> ansible</a>
</li>
<li>
<a href=/tags/automation><i class="fas fa-tags"></i> automation</a>
</li>
<li>
<a href=/tags/azure><i class="fas fa-tags"></i> azure</a>
</li>
<li>
<a href=/tags/debugging><i class="fas fa-tags"></i> debugging</a>
</li>
<li>
<a href=/tags/docker><i class="fas fa-tags"></i> docker</a>
</li>
<li>
<a href=/tags/draft><i class="fas fa-tags"></i> draft</a>
</li>
<li>
<a href=/tags/etcd><i class="fas fa-tags"></i> etcd</a>
</li>
<li>
<a href=/tags/git><i class="fas fa-tags"></i> git</a>
</li>
<li>
<a href=/tags/haproxy><i class="fas fa-tags"></i> haproxy</a>
</li>
<li>
<a href=/tags/heat><i class="fas fa-tags"></i> heat</a>
</li>
<li>
<a href=/tags/hybrid-cloud><i class="fas fa-tags"></i> hybrid-cloud</a>
</li>
<li>
<a href=/tags/install><i class="fas fa-tags"></i> install</a>
</li>
<li>
<a href=/tags/kubernetes><i class="fas fa-tags"></i> kubernetes</a>
</li>
<li>
<a href=/tags/mac><i class="fas fa-tags"></i> mac</a>
</li>
<li>
<a href=/tags/metrics><i class="fas fa-tags"></i> metrics</a>
</li>
<li>
<a href=/tags/migration><i class="fas fa-tags"></i> migration</a>
</li>
<li>
<a href=/tags/monitoring><i class="fas fa-tags"></i> monitoring</a>
</li>
<li>
<a href=/tags/networking><i class="fas fa-tags"></i> networking</a>
</li>
<li>
<a href=/tags/openshift><i class="fas fa-tags"></i> openshift</a>
</li>
<li>
<a href=/tags/openstack><i class="fas fa-tags"></i> openstack</a>
</li>
<li>
<a href=/tags/operators><i class="fas fa-tags"></i> operators</a>
</li>
<li>
<a href=/tags/python><i class="fas fa-tags"></i> python</a>
</li>
<li>
<a href=/tags/router><i class="fas fa-tags"></i> router</a>
</li>
<li>
<a href=/tags/ssl><i class="fas fa-tags"></i> ssl</a>
</li>
<li>
<a href=/tags/troubleshooting><i class="fas fa-tags"></i> troubleshooting</a>
</li>
<li>
<a href=/tags/upgrade><i class="fas fa-tags"></i> upgrade</a>
</li>
<li>
<a href=/tags/vagrant><i class="fas fa-tags"></i> vagrant</a>
</li>
<li>
<a href=/tags/virtualization><i class="fas fa-tags"></i> virtualization</a>
</li>
<li>
<a href=/tags/windows><i class="fas fa-tags"></i> windows</a>
</li>
<li>
<a href=/tags/zabbix><i class="fas fa-tags"></i> zabbix</a>
</li>
<li>
<a href=/tags/zimbra><i class="fas fa-tags"></i> zimbra</a>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<footer id=footer>
<div class=container>
<div class="col-md-4 col-sm-6">
<h4>Share</h4>
<i class="fab fa-2x fa-twitter" title="Share this on Twitter" onclick="window.open('http://twitter.com/home?status=http://guifreelife.com/blog/2022/05/13/OpenShift-Virtualization-on-vSphere/')"></i>
<i class="fab fa-2x fa-facebook" title="Share this on Facebook" onclick="window.open('http://www.facebook.com/share.php?u=http://guifreelife.com/blog/2022/05/13/OpenShift-Virtualization-on-vSphere/')"></i>
<i class="fab fa-2x fa-linkedin" title="Share this on Linkedin" onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url=http://guifreelife.com/blog/2022/05/13/OpenShift-Virtualization-on-vSphere/&title=&summary=&source=')"></i>
<i class="fab fa-2x fa-google-plus" title="Share this on Google Currents" onclick="window.open('https://plus.google.com/share?url=http://guifreelife.com/blog/2022/05/13/OpenShift-Virtualization-on-vSphere/')"></i>
<i class="fa fa-2x fa-envelope" title="Share this through Email" onclick="window.open('mailto:?&body=http://guifreelife.com/blog/2022/05/13/OpenShift-Virtualization-on-vSphere/')"></i>
<h4>About us</h4>
<p>GUI Free Life is the personal, technical blog of Dale Bewley. Comments and opinions are my own and not that of my employers.</p>
<hr class="hidden-md hidden-lg hidden-sm">
</div>
<div class="col-md-4 col-sm-6">
<h4>Recent posts</h4>
<div class=blog-entries>
<div class="item same-height-row clearfix">
<div class="image same-height-always">
<a href=http://guifreelife.com/blog/2022/05/13/OpenShift-Virtualization-on-vSphere/>
<img src=/images/shutterstock_2100290518.jpg class=img-responsive alt="OpenShift Virtualization on vSphere">
</a>
</div>
<div class="name same-height-always">
<h5><a href=http://guifreelife.com/blog/2022/05/13/OpenShift-Virtualization-on-vSphere/>OpenShift Virtualization on vSphere</a></h5>
</div>
</div>
<div class="item same-height-row clearfix">
<div class="image same-height-always">
<a href=http://guifreelife.com/blog/2022/03/10/Debugging-AWS-STS-Authentication-for-OpenShift-Operators/>
<img src=/images/debug-sts-banner.jpg class=img-responsive alt="Debugging AWS STS Authentication for OpenShift Operators">
</a>
</div>
<div class="name same-height-always">
<h5><a href=http://guifreelife.com/blog/2022/03/10/Debugging-AWS-STS-Authentication-for-OpenShift-Operators/>Debugging AWS STS Authentication for OpenShift Operators</a></h5>
</div>
</div>
<div class="item same-height-row clearfix">
<div class="image same-height-always">
<a href=http://guifreelife.com/blog/2021/12/21/Red-Hat-Advanced-Cluster-Management-Walkthrough/>
<img src=/images/port-of-oakland.png class=img-responsive alt="Red Hat Advanced Cluster Management Walkthrough">
</a>
</div>
<div class="name same-height-always">
<h5><a href=http://guifreelife.com/blog/2021/12/21/Red-Hat-Advanced-Cluster-Management-Walkthrough/>Red Hat Advanced Cluster Management Walkthrough</a></h5>
</div>
</div>
</div>
<hr class="hidden-md hidden-lg">
</div>
<div class="col-md-4 col-sm-6">
<h4>Contact</h4>
<p class=text-uppercase><strong>Dale Bewley</strong>
<br>Oakland
<br>California
<br>
<strong>USA</strong>
</p>
<a href=/contact class="btn btn-small btn-template-main">Go to contact page</a>
<hr class="hidden-md hidden-lg hidden-sm">
</div>
</div>
</footer>
<div id=copyright>
<div class=container>
<div class=col-md-12>
<p class=pull-left>Copyright (c) 2021, Dale Bewley; all rights reserved.</p>
<p class=pull-right>
Template by <a href=https://bootstrapious.com/p/universal-business-e-commerce-template>Bootstrapious</a>.
Ported to Hugo by <a href=https://github.com/devcows/hugo-universal-theme>DevCows</a>.
</p>
</div>
</div>
</div>
</div>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-39TSW9349X"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-39TSW9349X',{anonymize_ip:!1})}</script>
<script src=//code.jquery.com/jquery-3.1.1.min.js integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin=anonymous></script>
<script src=//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/Counter-Up/1.0/jquery.counterup.min.js></script>
<script src=//cdnjs.cloudflare.com/ajax/libs/jquery-parallax/1.1.3/jquery-parallax.js></script>
<script src="//maps.googleapis.com/maps/api/js?key=AIzaSyDacpwSIXi6lk2fS2wzZOSoh7iHm_ZP3UE&v=3.exp"></script>
<script src=/js/hpneo.gmaps.js></script>
<script src=/js/gmaps.init.js></script>
<script src=/js/front.js></script>
<script src=/js/owl.carousel.min.js></script>
</body>
</html>