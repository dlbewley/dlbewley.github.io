<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta name=viewport content="width=device-width,initial-scale=1"><title>OpenShift CoreOS On-Cluster Custom Node Image Layering | GUI Free Life</title><meta name=author content="Dale Bewley"><meta name=keywords content="bewley,guifreelife,coreos,openshift,kubernetes,operators"><meta name=description content="CoreOS On-cluster Image Layering in OpenShift 4.19 allows modifications to node the operating system. This detailed walk through customizes the node operating system image by adding RPMs to support autofs."><meta name=generator content="Hugo 0.147.8"><link href='//fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,500,700,800' rel=stylesheet type=text/css><link rel=stylesheet href=//use.fontawesome.com/releases/v5.11.2/css/all.css><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link href=/css/animate.css rel=stylesheet><link href=/css/style.turquoise.css rel=stylesheet id=theme-stylesheet><link href=/css/custom.css rel=stylesheet><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel="shortcut icon" href=/img/favicon.ico type=image/x-icon><link rel=apple-touch-icon href=/img/apple-touch-icon.png><link href=/css/owl.carousel.css rel=stylesheet><link href=/css/owl.theme.css rel=stylesheet><link rel=alternate href=http://guifreelife.com/index.xml type=application/rss+xml title="GUI Free Life"><meta property="og:locale" content="en_us"><meta property="og:site_name" content="GUI Free Life"><meta property="og:title" content="OpenShift CoreOS On-Cluster Custom Node Image Layering"><meta property="og:type" content="article"><meta property="og:url" content="http://guifreelife.com/blog/2025/06/20/CoreOS-Image-Layering-Autofs/"><meta property="og:description" content="CoreOS On-cluster Image Layering in OpenShift 4.19 allows modifications to node the operating system. This detailed walk through customizes the node operating system image by adding RPMs to support autofs."><meta property="og:image" content="http://guifreelife.com/images/layering-cake-trans.png"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content="1600"><meta property="og:image:height" content="1036"><meta property="og:updated_time" content="2025-06-20T00:00:00Z"><meta property="article:tag" content="coreos"><meta property="article:tag" content="openshift"><meta property="article:tag" content="kubernetes"><meta property="article:tag" content="operators"><meta property="article:published_time" content="2025-06-20T00:00:00Z"><meta property="article:modified_time" content="2025-06-20T00:00:00Z"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="OpenShift CoreOS On-Cluster Custom Node Image Layering"><meta name=twitter:image content="http://guifreelife.com/images/layering-cake-trans.png"><meta name=twitter:description content="CoreOS On-cluster Image Layering in OpenShift 4.19 allows modifications to node the operating system. This detailed walk through customizes the node operating system image by adding RPMs to support ‚Ä¶"><link rel=stylesheet type=text/css href=/css/asciinema-player.css><script src=/js/asciinema-player.js></script></head><body><div id=all><header class=navbar-affixed-top data-spy=affix data-offset-top=62><div class="navbar navbar-default yamm" role=navigation id=navbar><div class=container><div class=navbar-header><a class="navbar-brand home" href=/><img src=/img/logo.png alt="OpenShift CoreOS On-Cluster Custom Node Image Layering logo" class="hidden-xs hidden-sm">
<img src=/img/logo-small.png alt="OpenShift CoreOS On-Cluster Custom Node Image Layering logo" class="visible-xs visible-sm">
<span class=sr-only>OpenShift CoreOS On-Cluster Custom Node Image Layering - go to homepage</span></a><div class=navbar-buttons><button type=button class="navbar-toggle btn-template-main" data-toggle=collapse data-target=#navigation>
<span class=sr-only>Toggle Navigation</span>
<i class="fas fa-align-justify"></i></button></div></div><div class="navbar-collapse collapse" id=navigation><ul class="nav navbar-nav navbar-right"><li class=dropdown><a href=/>Home</a></li><li class="dropdown active"><a href=/blog/>Blog</a></li><li class=dropdown><a href=/contact/>Contact</a></li></ul></div><div class="collapse clearfix" id=search><form class=navbar-form role=search><div class=input-group><input type=text class=form-control placeholder=Search>
<span class=input-group-btn><button type=submit class="btn btn-template-main"><i class="fas fa-search"></i></button></span></div></form></div></div></div></header><style>.bar.background-image-fixed-banner{background:url(/images/layering-cake-trans.png)50% 0 no-repeat;background-attachment:fixed;background-size:cover;padding:100px 5%;text-shadow:2px 3px 4px var(--primary-accent),0 0 1em var(--navbar-border-top)}</style><div><div class=container><div class=row><div class=col-md-12><section class="bar background-image-fixed-banner heading h2 color-white text-center"><h1>OpenShift CoreOS On-Cluster Custom Node Image Layering</h1></section></div></div></div></div><div id=content><div class=container><div class=row><div class=col-md-9 id=blog-post><p class="text-muted text-uppercase mb-small text-right">June 20, 2025</p><div id=post-content><p>CoreOS On-cluster Image Layering in OpenShift 4.19 allows modifications to node the operating system. This detailed walk through customizes the node operating system image by adding RPMs to support autofs.</p><p>In <a href=http://guifreelife.com/coming-soon/ title="Configuring AutoFS on OpenShift">part 2</a> we will configure autofs and enable automatic filesystem mounting across cluster nodes.</p><h1 id=background>Background</h1><p>RHEL CoreOS is a container optimized operating system which is distributed via a container image. OpenShift leverages this capability to keep the operating system up to date without the need to apply individual patches to nodes in the cluster.</p><p>Typically software will not be installed directly into the host operating system, but instead provided via images running in containers managed by Kubernetes. There are cases where it may be desirable to add packages directly to the operating system, however.</p><p>The RHCOS <a href=https://docs.redhat.com/en/documentation/openshift_container_platform/4.19/html/machine_configuration/mco-coreos-layering title="RHCOS image layering Docs">Image Layering</a> feature of OpenShift allows for the ability to modify the container image that provides the CoreOS operating system image in a manner compatible with the automated node lifecycle management performed by the OpenShift <a href=https://github.com/openshift/machine-config-operator title="Machine Config Operator">Machine Config Operator</a>.</p><h1 id=the-challenge---missing-rpms>The Challenge - Missing RPMs</h1><blockquote><p>‚ùì <strong>How can I install RPMs on my OpenShift nodes?</strong></p></blockquote><p>I want to run the automount daemon on cluster nodes so I can expose dynamic NFS mounts from existing infrastructure to OpenShift workloads. Once the mounts are trigged by accessing a path on the host, the mounted filesystem can be exposed to pods via a <a href=https://kubernetes.io/docs/concepts/storage/volumes/#hostpath title="Kubernetes hostPath Volumes">hostPath volume</a>, but the <code>autofs</code> RPM is not on installed on the nodes.</p><p>I could run automountd <a href=https://github.com/dlbewley/demo-autofs/tree/main/automount title="Automount in a container">in a container</a>, but that presents some challenges like also configuring and accessing <code>sssd</code> for user and automount lookups in LDAP, propagating the mounts back to the host. This would also make me responsible for building and maintaining the image that provides autofs. Having automountd running directly in the node operating system is the prefered solution in this case.</p><p>So how do I get the autofs and related RPMs installed on the nodes?</p><p>By adding the RPMs to the container image the nodes are running.</p><blockquote><p>üí° <strong>Install RPMs by layering on top of the node CoreOS image.</strong></p></blockquote><h2 id=understanding-on-cluster-layering>Understanding On-Cluster Layering</h2><p>Out-of-cluster layering made it possible to build and host a custom CoreOS image for nodes on an external registry.</p><p>On-Cluster Layering or OCL is a GA feature in OpenShift 4.19 that enables the building and management of custom node images to take place entirely within the cluster.</p><p>The <code>MachineOSConfig</code> resource defines the production of the layered image. It specifies the following parameters:</p><ul><li>Association to a single <code>MachineConfigPool</code></li><li>Registry location to push & pull the layered image</li><li>The regsitry credentials required to push and pull</li><li>Containerfile (Dockerfile) to build the image</li></ul><p>The Containerfile will be embeded in the MachineOSConfig, but on it&rsquo;s own it may look like this:</p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#8b008b;font-weight:700>FROM</span><span style=color:#cd5555> configs AS final</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span><span style=display:flex><span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#8b008b;font-weight:700>RUN</span> dnf install -y <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>        autofs <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>        openldap-clients <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>        &amp;&amp; dnf clean all <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>        &amp;&amp; ostree container commit<span style=color:#a61717;background-color:#e3d2d2>
</span></span></span></code></pre></div><blockquote><p>‚≠ê <strong>Tip</strong></p><p>Using a custom layered image does result in more reboots than the default image. Certificate rotation and smaller config changes will cause reboots that are otherwise avoided and any changes to the machineconfigs require a image rebuild. Pausing the MachineConfigPool during MachineConfig changes can minimize reboots.</p></blockquote><h1 id=preparing-for-on-cluster-image-layering>Preparing for On-Cluster Image Layering</h1><h2 id=image-registry>Image Registry</h2><p>The custom image we are creating must be pushed to a container image registry. The on-cluster registry can be used for that if it is <a href=https://docs.redhat.com/en/documentation/openshift_container_platform/4.19/html/registry/setting-up-and-configuring-the-registry#configuring-registry-storage-baremetal title="Configuring the OpenShift Image Registry">enabled</a>. That is what I will <a href=https://github.com/dlbewley/demo-autofs/blob/main/layering/readme.md#provisioning-an-image-registry-to-hold-layered-image title="Image Registry Configuration Notes">use here</a>.</p><h2 id=creating-pull-secrets-for-the-image-build>Creating Pull Secrets for the Image Build</h2><p>To upload (push) or download (pull) an image from a registry requires a credential called a &ldquo;pull-secret&rdquo;.</p><p>OpenShift includes a global pull secret which is supplied during installation and stored in the <code>openshift-config</code> namespace. This has privilege to download the base CoreOS image, but we also need a credential to push our custom image to a registry.</p><p>The image will be built by the <em>builder</em> ServiceAccount in the <code>openshift-machine-config-operator</code> namespace, so we need to create a credential and associate it with this user.</p><blockquote><span class=expand><span class=expand-label style=cursor:pointer onclick='$h=$(this),$h.next("div").slideToggle(200,function(){$h.children("i").attr("class",function(){return $h.next("div").is(":visible")?"fas fa-chevron-down":"fas fa-chevron-right"})})'>üîß <strong>Creating a Builder Pull Secret for Pushing</strong>
<i class="fas fa-chevron-down"></i></span><div class=expand-content style="display:block;margin:10px 0"><p>üìì <strong>Important</strong>
Tokens have a default 1 hour expiration. In this example we will set this to 2 years. Your approach may differ.</p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#228b22># üîß prepare a service account to build and push images to the registry</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#658b00>export</span> <span style=color:#00688b>REGISTRY</span>=image-registry.openshift-image-registry.svc:5000
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#658b00>export</span> <span style=color:#00688b>REGISTRY_NAMESPACE</span>=openshift-machine-config-operator
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#228b22># ü§ñ the builder serviceaccount has rolebinding/system:image-builders</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#658b00>export</span> <span style=color:#00688b>REGISTRY_USER</span>=builder
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#228b22># üîß create a long duration (2 years) token for the service account</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#658b00>export</span> <span style=color:#00688b>TOKEN</span>=<span style=color:#8b008b;font-weight:700>$(</span>oc create token <span style=color:#00688b>$REGISTRY_USER</span> -n <span style=color:#00688b>$REGISTRY_NAMESPACE</span> --duration=<span style=color:#8b008b;font-weight:700>$((</span><span style=color:#b452cd>720</span>*<span style=color:#b452cd>24</span><span style=color:#8b008b;font-weight:700>))</span>h<span style=color:#8b008b;font-weight:700>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#228b22># üîß use this token to create a pull secret for the cluster registry</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>oc create secret docker-registry push-secret <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#cd5555></span>  -n openshift-machine-config-operator <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#cd5555></span>  --docker-server=<span style=color:#00688b>$REGISTRY</span> <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#cd5555></span>  --docker-username=<span style=color:#00688b>$REGISTRY_USER</span> <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#cd5555></span>  --docker-password=<span style=color:#00688b>$TOKEN</span>
</span></span></code></pre></div></div></span></blockquote><p>Testing revealed that the same pull secret is used for pulling the standard images, so we need to combine this created secret with the global pull secret.</p><blockquote><span class=expand><span class=expand-label style=cursor:pointer onclick='$h=$(this),$h.next("div").slideToggle(200,function(){$h.children("i").attr("class",function(){return $h.next("div").is(":visible")?"fas fa-chevron-down":"fas fa-chevron-right"})})'>üîß <strong>Combining the Global Pull Secret with the Builder Pull Secret for Pulling</strong>
<i class="fas fa-chevron-down"></i></span><div class=expand-content style="display:block;margin:10px 0"><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#228b22># ü™è extract the just created &#39;push&#39; secret to a file</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>oc extract secret/push-secret -n openshift-machine-config-operator --to=- &gt; push-secret.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#228b22># ü™è extract the cluster global pull secret to a file</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>oc extract secret/pull-secret -n openshift-config --to=- &gt; pull-secret.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#228b22># üîß combine the global pull secret and the just created push secret</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>jq -s <span style=color:#cd5555>&#39;.[0] * .[1]&#39;</span> pull-secret.json push-secret.json &gt; pull-and-push-secret.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#228b22># üîß create a new secret to hold the pull-and-push secret</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>oc create secret generic pull-and-push-secret <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#cd5555></span>  -n openshift-machine-config-operator <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#cd5555></span>  --from-file=.dockerconfigjson=pull-and-push-secret.json <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#cd5555></span>  --type=kubernetes.io/dockerconfigjson
</span></span></code></pre></div></div></span></blockquote><h3 id=demo>Demo</h3><p>üëÄ <em>Watch a demonstration of above.</em></p><blockquote><span class=expand><span class=expand-label style=cursor:pointer onclick='$h=$(this),$h.next("div").slideToggle(200,function(){$h.children("i").attr("class",function(){return $h.next("div").is(":visible")?"fas fa-chevron-down":"fas fa-chevron-right"})})'>üì∫ <strong>ASCII Screencast Demo of Pull and Push Secret Configuration</strong>
<i class="fas fa-chevron-down"></i></span><div class=expand-content style="display:block;margin:10px 0"><p>CoreOS Image Layering Demo - Pull and Push Secrets</p><p><asciinema-player src=/casts/layering-01-secrets-20250603_1502.cast cols=640 rows=50 loop start-at=0 speed=1 poster=npt:1:06 font-size=smaller></asciinema-player></p><a href=https://asciinema.org/a/721881>Asciinema</a>, <a href=https://github.com/dlbewley/demo-autofs/blob/main/layering/demo-script-layering-01.sh>Script</a></div></span></blockquote><h1 id=building-the-coreos-image>Building the CoreOS Image</h1><h2 id=creating-the-worker-automount-machineconfigpool>Creating the worker-automount MachineConfigPool</h2><p>We need a way to associate the custom image with the nodes of our choosing. This will be done using the <code>MachineConfigPool</code> (MCP) resource as shown below. This is also how we will associate the added configuration values a bit later. You can learn a bit more about MachineConfigPools in <a href=http://guifreelife.com/blog/2025/05/29/Managing-OpenShift-Machine-Configuration-with-Butane-and-Ignition/ title="Managing MachineConfigs with Butane">this blog post</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8b008b;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>machineconfiguration.openshift.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>kind</span>:<span style=color:#bbb> </span>MachineConfigPool<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>annotation</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>description</span>:<span style=color:#bbb> </span>Worker nodes with automount enabled<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>pools.operator.machineconfiguration.openshift.io/worker-automount</span>:<span style=color:#bbb> </span><span style=color:#cd5555>&#34;&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex;background-color:#d6d6c6><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>worker-automount<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>machineConfigSelector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>matchExpressions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#bbb>      </span>- <span style=color:#8b008b;font-weight:700>key</span>:<span style=color:#bbb> </span>machineconfiguration.openshift.io/role<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>operator</span>:<span style=color:#bbb> </span>In<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>values</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex;background-color:#d6d6c6><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#bbb>          </span>- worker<span style=color:#bbb>
</span></span></span><span style=display:flex;background-color:#d6d6c6><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#bbb>          </span>- worker-automount<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>nodeSelector</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex;background-color:#d6d6c6><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>node-role.kubernetes.io/worker-automount</span>:<span style=color:#bbb> </span><span style=color:#cd5555>&#34;&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex;background-color:#d6d6c6><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>paused</span>:<span style=color:#bbb> </span><span style=color:#8b008b;font-weight:700>true</span><span style=color:#bbb>
</span></span></span></code></pre></div><p><em><a href=https://github.com/dlbewley/demo-autofs/blob/main/layering/machineconfigpool.yaml title=MachineConfigPool>MachineConfigPool</a></em></p><p>On line 19 we say that this MachineConfigPool will nclude nodes that are labeled with &ldquo;node-role.kubernetes.io/worker-automount&rdquo;, and on lines 15 and 16 we specify that any <code>MachineConfig</code> resources labeled with either &ldquo;worker&rdquo; or &ldquo;worker-automount&rdquo; will be used for those machines. Also notice on line 20 that we are defining this pool as &ldquo;paused&rdquo; by default.</p><blockquote><p>üîß <strong>Creating the &ldquo;worker-automount&rdquo; MachineConfigPool</strong></p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>oc create -f machineconfigpool.yaml
</span></span></code></pre></div></blockquote><p>Because we are not creating any MachineConfig resources <a href=http://guifreelife.com/coming-soon/ title="Configuring AutoFS on OpenShift">yet</a> the nodes in this pool will be configured just like any existing worker nodes, <em>except</em> once we create the <code>MachineOSConfig</code> below the nodes in the pool will also have our custom image applied.</p><h2 id=creating-the-worker-automount-machineosconfig>Creating the worker-automount MachineOSConfig</h2><p>Here is the <code>MachineOSConfig</code> which will be associated with the worker-automount <code>MachineConfigPool</code> above. This will define how to build the image.</p><p>Using the pull secrets we created above, it will push the image to the registry at the location specified.</p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#8b008b;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>machineconfiguration.openshift.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>kind</span>:<span style=color:#bbb> </span>MachineOSConfig<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>worker-automount<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>machineConfigPool</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex;background-color:#d6d6c6><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>worker-automount<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>containerFile</span>:<span style=color:#bbb> 
</span></span></span><span style=display:flex;background-color:#d6d6c6><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#bbb>  </span>- <span style=color:#8b008b;font-weight:700>content</span>:<span style=color:#bbb> </span>|-<span style=color:#cd5555>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#cd5555>      FROM configs AS final
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#cd5555>      RUN dnf install -y \
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#cd5555>        autofs \
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#cd5555>        libsss_autofs \
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#cd5555>        openldap-clients \
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#cd5555>        &amp;&amp; dnf clean all \
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#cd5555>        &amp;&amp; ostree container commit</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>imageBuilder</span>:<span style=color:#bbb> 
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>imageBuilderType</span>:<span style=color:#bbb> </span>Job<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>baseImagePullSecret</span>:<span style=color:#bbb> 
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#bbb>    </span><span style=color:#228b22># baseImagePullSecret is the secret used to pull the base image</span><span style=color:#bbb>
</span></span></span><span style=display:flex;background-color:#d6d6c6><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>pull-and-push-secret<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>renderedImagePushSecret</span>:<span style=color:#bbb> 
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#bbb>    </span><span style=color:#228b22># renderedImagePushSecret is the secret used to push the custom image</span><span style=color:#bbb>
</span></span></span><span style=display:flex;background-color:#d6d6c6><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>push-secret<span style=color:#bbb>
</span></span></span><span style=display:flex;background-color:#d6d6c6><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>renderedImagePushSpec</span>:<span style=color:#bbb> </span>image-registry.openshift-image-registry.svc:5000/openshift-machine-config-operator/os-image:latest <span style=color:#bbb>
</span></span></span></code></pre></div><p><em><a href=https://github.com/dlbewley/demo-autofs/blob/main/layering/machineosconfig.yaml title=MachineOSConfig>MachineOSConfig</a></em></p><p>On line 7 we are specifying that this MachineOSConfig is to be applied to the &ldquo;worker-automount&rdquo; pool. In the content section we have the Containerfile instructions. On line 21 and 24 we reference the secrets holding the necessary registry credentials, and line 25 defines where the built image will be pushed to.</p><blockquote><p>üîß <strong>Creating the &ldquo;worker-automount&rdquo; MachineOSConfig</strong></p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>oc create -f machineosconfig.yaml
</span></span></code></pre></div></blockquote><p>üå≥ <strong>In the Weeds</strong></p><p>Here is what happens when you create a <code>MachineOSConfig</code> named &ldquo;worker-automount&rdquo;:</p><ul><li>creates a <code>deployment/machine-os-builder</code> which creates a <code>pod/machine-os-builder-&lt;hash></code></li><li><code>pod/machine-os-builder-&lt;hash></code> waits to acquire a lease</li><li><code>pod/machine-os-builder-&lt;hash></code> creates a <code>machineosbuild/worker-automount-&lt;hash></code> resource</li><li><code>pod/machine-os-builder-&lt;hash></code> creates a <code>job/build-worker-automount-&lt;hash></code></li><li><code>job/build-worker-automount-&lt;hash></code> creates a <code>pod/build-worker-automount-&lt;hash></code> to perform the build.</li><li>This pod log shows the build progress. ^</li></ul><p>Once the image is pushed it is visible in an <code>ImageStream</code> in the openshift-machine-config-operator namespace.</p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>oc get describe imagestream/os-image -n openshift-machine-config-operator
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h3 id=demo-1>Demo</h3><p>üëÄ <em>Watch a demonstration of above.</em></p><blockquote><span class=expand><span class=expand-label style=cursor:pointer onclick='$h=$(this),$h.next("div").slideToggle(200,function(){$h.children("i").attr("class",function(){return $h.next("div").is(":visible")?"fas fa-chevron-down":"fas fa-chevron-right"})})'>üì∫ <strong>ASCII Screencast Demo of MachineConfigPool and Custom Image Setup</strong>
<i class="fas fa-chevron-right"></i></span><div class=expand-content style="display:none;margin:10px 0"><p>CoreOS Image Layering Demo - Machine Config Pool and MachineOSConfig</p><p><asciinema-player src=/casts/layering-02-machineosconfig-20250609_1929.cast cols=640 rows=50 loop start-at=0 speed=1 poster=npt:0:07 font-size=smaller></asciinema-player></p><a href=https://asciinema.org/a/722700>Asciinema</a>, <a href=https://github.com/dlbewley/demo-autofs/blob/main/layering/demo-script-layering-02.sh>Script</a></div></span></blockquote><h1 id=deploying-the-layered-image>Deploying the Layered Image</h1><blockquote><p>‚ö†Ô∏è <strong>Warning!</strong></p><p>Until <a href=https://issues.redhat.com/browse/OCPBUGS-56648 title="Bug: layered image update loops on failure to find systemd unit files">üêõ OCPBUGS-56648</a> is repaired, it is important that the custom image is deployed to nodes before any MachineConfigs that refer to new components <a href=http://guifreelife.com/coming-soon/ title="Configuring AutoFS on OpenShift">are added</a>. eg. Do not <code>systemctl enable autofs</code> until the layered image having autofs installed is fully deployed.</p><p><em>Another possible workaround would be to make this change in the Containerfile.</em></p></blockquote><h2 id=node-imaging>Node Imaging</h2><p>With the necessary changes layered onto the CoreOS image and that image assocated to a pool, the next step is to add a node to the pool and cause the CoreOS image to be redeployed.</p><p>This is done by labeling the node with the role variable the pool is using to select nodes.</p><blockquote><p>üîß <strong>Adding a Node to the &ldquo;worker-automount&rdquo; MachineConfigPool</strong></p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#228b22># üéØ Select a test node</span>
</span></span><span style=display:flex><span><span style=color:#00688b>TEST_WORKER</span>=hub-v57jl-worker-0-jlvfs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># üè∑Ô∏è  Adjust node-role label &amp; move it to worker-automount pool</span>
</span></span><span style=display:flex><span>oc label node <span style=color:#00688b>$TEST_WORKER</span> <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>   node-role.kubernetes.io/worker- <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>   node-role.kubernetes.io/worker-automount=<span style=color:#cd5555>&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#228b22># üîç worker-automount MCP now has a node count of 1</span>
</span></span><span style=display:flex><span>oc get mcp -o custom-columns=<span style=color:#cd5555>&#39;NAME:.metadata.name, MACHINECOUNT:.status.machineCount&#39;</span>
</span></span><span style=display:flex><span>NAME               MACHINECOUNT
</span></span><span style=display:flex><span>master             <span style=color:#b452cd>3</span>
</span></span><span style=display:flex><span>worker             <span style=color:#b452cd>7</span>
</span></span><span style=display:flex><span>worker-automount   <span style=color:#b452cd>1</span>
</span></span></code></pre></div></blockquote><p>Now the update can be triggered by unpausing the pool. After this change, any further changes that affect the &ldquo;worker-automount&rdquo; MachineConfigPool will automatically be applied.</p><blockquote><p>üîß Unpausing the worker-automount MachineConfigPool to begin updates</p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>oc patch machineconfigpool/worker-automount <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>    --type merge --patch <span style=color:#cd5555>&#39;{&#34;spec&#34;:{&#34;paused&#34;:false}}&#39;</span><span style=color:#cd5555>&#34;
</span></span></span></code></pre></div></blockquote><p>With the pool unpaused, the <code>MachineConfigDaemon</code> running on nodes in the pool will begin applying the rendered machineconfig by cordoning and draining the node. The node will then reboot and begin running the custom image.</p><p>The machine config daemon log can be watched as the node is updated.</p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#00688b>MCD_POD</span>=<span style=color:#8b008b;font-weight:700>$(</span>oc get pods -A -l k8s-app=machine-config-daemon --field-selector=spec.host=<span style=color:#00688b>$TEST_WORKER</span> -o name<span style=color:#8b008b;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>oc logs -n openshift-machine-config-operator -f <span style=color:#00688b>$MCD_POD</span>
</span></span><span style=display:flex><span>... üëÄ look <span style=color:#8b008b;font-weight:700>for</span> something like this at the end...
</span></span><span style=display:flex><span>I0611 17:26:38.595644    <span style=color:#b452cd>3512</span> update.go:2786] <span style=color:#cd5555>&#34;Validated on-disk state&#34;</span>
</span></span><span style=display:flex><span>I0611 17:26:38.607920    <span style=color:#b452cd>3512</span> daemon.go:2340] Completing update to target MachineConfig: rendered-worker-automount-5ffdffe14badbefb26817971e15627a6 / Image: image-registry.openshift-image-registry.svc:5000/openshift-machine-config-operator/os-image@sha256:326d0638bb78f372e378988a4bf86c46005ccba0b269503ee05e841ea127945e
</span></span><span style=display:flex><span>I0611 17:26:48.790395    <span style=color:#b452cd>3512</span> update.go:2786] <span style=color:#cd5555>&#34;Update completed for config rendered-worker-automount-5ffdffe14badbefb26817971e15627a6 and node has been successfully uncordoned&#34;</span>
</span></span></code></pre></div><p>Once the node is back online check to confirm that the autofs rpm is now present.</p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#228b22># ‚úÖ Verify that the autofs RPM now exists on the node</span>
</span></span><span style=display:flex><span>oc debug node/<span style=color:#00688b>$TEST_WORKER</span> -- chroot /host rpm -q autofs 2&gt;/dev/null
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>autofs-5.1.7-60.el9.x86_64
</span></span></code></pre></div><p>üëÄ <em>Watch a demonstration of above.</em></p><blockquote><span class=expand><span class=expand-label style=cursor:pointer onclick='$h=$(this),$h.next("div").slideToggle(200,function(){$h.children("i").attr("class",function(){return $h.next("div").is(":visible")?"fas fa-chevron-down":"fas fa-chevron-right"})})'>üì∫ <strong>ASCII Screencast Demo of Applying Custom Image to Nodes</strong>
<i class="fas fa-chevron-right"></i></span><div class=expand-content style="display:none;margin:10px 0"><p>CoreOS Image Layering Demo - Node Imaging</p><p><asciinema-player src=/casts/layering-03-imaging-20250611_1148.cast cols=640 rows=50 loop start-at=0 speed=1 poster=npt:0:11 font-size=smaller></asciinema-player></p><a href=https://asciinema.org/a/722913>Asciinema</a>,
<a href=https://github.com/dlbewley/demo-autofs/blob/main/layering/demo-script-layering-03.sh>Script</a></div></span></blockquote><h1 id=summary>Summary</h1><p>On cluster iamge layering allows for customizing of the OpenShift node operating system with the responsibility of maintaining the image adeptly managed by the cluster its self.</p><p>üöÄ Now that we have added the RPMs to support it, we can proceed to configure autofs by teaching <code>sssd</code> how to talk to our LDAP server to look up users and automount maps, and by accounting for CoreOS requirements.</p><p>Be sure to checkout <a href=http://guifreelife.com/coming-soon/ title="Configuring AutoFS on OpenShift">part 2 of this series</a> where we will do exactly that!</p><h1 id=references>References</h1><ul><li><a href=https://github.com/dlbewley/demo-autofs title="Demo Github Repo">Demo Github Repo</a></li><li><a href=https://asciinema.org/a/721881 title="Asciinema Demo Recording">Demo Recording</a></li><li><a href=https://docs.redhat.com/en/documentation/openshift_container_platform/4.19/html/machine_configuration/mco-coreos-layering title="RHCOS image layering Docs">RHCOS Image Layering Docs</a></li><li><a href=https://issues.redhat.com/browse/OCPBUGS-56648 title="Bug: layered image update loops on failure to find systemd unit files">üêõ layered image update loops on failure to find systemd unit files</a></li><li><a href=https://github.com/dlbewley/demo-autofs/tree/main/automount title="Automount in a container">Automount in a container</a></li><li><a href=https://github.com/dlbewley/demo-autofs/tree/main/layering title="Automount on the node">Automount on the node</a></li><li><a href=https://docs.redhat.com/en/documentation/openshift_container_platform/4.19/html/registry/setting-up-and-configuring-the-registry#configuring-registry-storage-baremetal title="Configuring the OpenShift Image Registry">Configuring the OpenShift Image Registry</a></li><li><a href=https://kubernetes.io/docs/concepts/storage/volumes/#hostpath title="Kubernetes hostPath Volumes">Kubernetes hostPath Volumes</a></li></ul></div></div><div class=col-md-3><div class="panel panel-default sidebar-menu"><div class=panel-heading><h3 class=panel-title>Search</h3></div><div class=panel-body><form action=//google.com/search method=get accept-charset=UTF-8 role=search><div class=input-group><input type=search name=q class=form-control placeholder=Search>
<input type=hidden name=sitesearch value=http://guifreelife.com/>
<span class=input-group-btn><button type=submit class="btn btn-template-main"><i class="fas fa-search"></i></button></span></div></form></div></div><div class="panel sidebar-menu"><div class=panel-heading><h3 class=panel-title>Tagged</h3></div><div class=panel-body><ul class=tag-cloud><li class=active><a href=/tags/coreos><i class="fas fa-tags"></i> coreos</a></li><li class=active><a href=/tags/openshift><i class="fas fa-tags"></i> openshift</a></li><li class=active><a href=/tags/kubernetes><i class="fas fa-tags"></i> kubernetes</a></li><li class=active><a href=/tags/operators><i class="fas fa-tags"></i> operators</a></li></ul></div></div><div class="panel sidebar-menu"><div class=panel-heading><h3 class=panel-title>TOC</h3></div><div class=panel-body><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#the-challenge---missing-rpms>The Challenge - Missing RPMs</a><ul><li><a href=#understanding-on-cluster-layering>Understanding On-Cluster Layering</a></li></ul></li><li><a href=#preparing-for-on-cluster-image-layering>Preparing for On-Cluster Image Layering</a><ul><li><a href=#image-registry>Image Registry</a></li><li><a href=#creating-pull-secrets-for-the-image-build>Creating Pull Secrets for the Image Build</a><ul><li><a href=#demo>Demo</a></li></ul></li></ul></li><li><a href=#building-the-coreos-image>Building the CoreOS Image</a><ul><li><a href=#creating-the-worker-automount-machineconfigpool>Creating the worker-automount MachineConfigPool</a></li><li><a href=#creating-the-worker-automount-machineosconfig>Creating the worker-automount MachineOSConfig</a><ul><li><a href=#demo-1>Demo</a></li></ul></li></ul></li><li><a href=#deploying-the-layered-image>Deploying the Layered Image</a><ul><li><a href=#node-imaging>Node Imaging</a></li></ul></li><li><a href=#summary>Summary</a></li><li><a href=#references>References</a></li></ul></nav></div></div><div class="panel sidebar-menu"><div class=panel-heading><h3 class=panel-title>Tags</h3></div><div class=panel-body><ul class=tag-cloud><li><a href=/tags/ansible><i class="fas fa-tags"></i> ansible</a></li><li><a href=/tags/automation><i class="fas fa-tags"></i> automation</a></li><li><a href=/tags/aws><i class="fas fa-tags"></i> aws</a></li><li><a href=/tags/azure><i class="fas fa-tags"></i> azure</a></li><li><a href=/tags/cdk><i class="fas fa-tags"></i> cdk</a></li><li><a href=/tags/coreos><i class="fas fa-tags"></i> coreos</a></li><li><a href=/tags/debugging><i class="fas fa-tags"></i> debugging</a></li><li><a href=/tags/docker><i class="fas fa-tags"></i> docker</a></li><li><a href=/tags/draft><i class="fas fa-tags"></i> draft</a></li><li><a href=/tags/etcd><i class="fas fa-tags"></i> etcd</a></li><li><a href=/tags/git><i class="fas fa-tags"></i> git</a></li><li><a href=/tags/haproxy><i class="fas fa-tags"></i> haproxy</a></li><li><a href=/tags/heat><i class="fas fa-tags"></i> heat</a></li><li><a href=/tags/hybrid-cloud><i class="fas fa-tags"></i> hybrid-cloud</a></li><li><a href=/tags/install><i class="fas fa-tags"></i> install</a></li><li><a href=/tags/kubeconfig><i class="fas fa-tags"></i> kubeconfig</a></li><li><a href=/tags/kubernetes><i class="fas fa-tags"></i> kubernetes</a></li><li><a href=/tags/mac><i class="fas fa-tags"></i> mac</a></li><li><a href=/tags/metrics><i class="fas fa-tags"></i> metrics</a></li><li><a href=/tags/migration><i class="fas fa-tags"></i> migration</a></li><li><a href=/tags/monitoring><i class="fas fa-tags"></i> monitoring</a></li><li><a href=/tags/networking><i class="fas fa-tags"></i> networking</a></li><li><a href=/tags/ocp3><i class="fas fa-tags"></i> ocp3</a></li><li><a href=/tags/ocp4><i class="fas fa-tags"></i> ocp4</a></li><li><a href=/tags/openshift><i class="fas fa-tags"></i> openshift</a></li><li><a href=/tags/openstack><i class="fas fa-tags"></i> openstack</a></li><li><a href=/tags/operators><i class="fas fa-tags"></i> operators</a></li><li><a href=/tags/prometheus><i class="fas fa-tags"></i> prometheus</a></li><li><a href=/tags/python><i class="fas fa-tags"></i> python</a></li><li><a href=/tags/rhacm><i class="fas fa-tags"></i> rhacm</a></li><li><a href=/tags/rhacs><i class="fas fa-tags"></i> rhacs</a></li><li><a href=/tags/rhel><i class="fas fa-tags"></i> rhel</a></li><li><a href=/tags/router><i class="fas fa-tags"></i> router</a></li><li><a href=/tags/security><i class="fas fa-tags"></i> security</a></li><li><a href=/tags/ssl><i class="fas fa-tags"></i> ssl</a></li><li><a href=/tags/stackrox><i class="fas fa-tags"></i> stackrox</a></li><li><a href=/tags/storage><i class="fas fa-tags"></i> storage</a></li><li><a href=/tags/troubleshooting><i class="fas fa-tags"></i> troubleshooting</a></li><li><a href=/tags/upgrade><i class="fas fa-tags"></i> upgrade</a></li><li><a href=/tags/vagrant><i class="fas fa-tags"></i> vagrant</a></li><li><a href=/tags/virtualization><i class="fas fa-tags"></i> virtualization</a></li><li><a href=/tags/webinar><i class="fas fa-tags"></i> webinar</a></li><li><a href=/tags/windows><i class="fas fa-tags"></i> windows</a></li><li><a href=/tags/zabbix><i class="fas fa-tags"></i> zabbix</a></li><li><a href=/tags/zimbra><i class="fas fa-tags"></i> zimbra</a></li></ul></div></div></div></div></div></div><footer id=footer><div class=container><div class="col-md-4 col-sm-6"><h4>Share</h4><i class="fab fa-2x fa-twitter" title="Share this on Twitter" onclick='window.open("http://twitter.com/home?status=http://guifreelife.com/blog/2025/06/20/CoreOS-Image-Layering-Autofs/")'></i>
<i class="fab fa-2x fa-facebook" title="Share this on Facebook" onclick='window.open("http://www.facebook.com/share.php?u=http://guifreelife.com/blog/2025/06/20/CoreOS-Image-Layering-Autofs/")'></i>
<i class="fab fa-2x fa-linkedin" title="Share this on Linkedin" onclick='window.open("https://www.linkedin.com/shareArticle?mini=true&url=http://guifreelife.com/blog/2025/06/20/CoreOS-Image-Layering-Autofs/&title=&summary=&source=")'></i>
<i class="fab fa-2x fa-google-plus" title="Share this on Google Currents" onclick='window.open("https://plus.google.com/share?url=http://guifreelife.com/blog/2025/06/20/CoreOS-Image-Layering-Autofs/")'></i>
<i class="fa fa-2x fa-envelope" title="Share this through Email" onclick='window.open("mailto:?&body=http://guifreelife.com/blog/2025/06/20/CoreOS-Image-Layering-Autofs/")'></i><h4>About us</h4><p>GUI Free Life is the personal, technical blog of Dale Bewley. Comments and opinions are my own and not that of my employers.</p><hr class="hidden-md hidden-lg hidden-sm"></div><div class="col-md-4 col-sm-6"><h4>Recent posts</h4><div class=blog-entries><div class="item same-height-row clearfix"><div class="image same-height-always"><a href=http://guifreelife.com/blog/2025/06/20/CoreOS-Image-Layering-Autofs/><img src=/images/layering-cake-trans.png class=img-responsive alt="OpenShift CoreOS On-Cluster Custom Node Image Layering"></a></div><div class="name same-height-always"><h5><a href=http://guifreelife.com/blog/2025/06/20/CoreOS-Image-Layering-Autofs/>OpenShift CoreOS On-Cluster Custom Node Image Layering</a></h5></div></div><div class="item same-height-row clearfix"><div class="image same-height-always"><a href=http://guifreelife.com/blog/2025/05/29/Managing-OpenShift-Machine-Configuration-with-Butane-and-Ignition/><img src=/images/machineconfigs-butane.png class=img-responsive alt="Managing Readable OpenShift MachineConfigs with Butane"></a></div><div class="name same-height-always"><h5><a href=http://guifreelife.com/blog/2025/05/29/Managing-OpenShift-Machine-Configuration-with-Butane-and-Ignition/>Managing Readable OpenShift MachineConfigs with Butane</a></h5></div></div><div class="item same-height-row clearfix"><div class="image same-height-always"><a href=http://guifreelife.com/blog/2025/04/09/Kubeconfig-for-OpenShift-Service-Accounts/><img src=/images/kubeconfig.jpeg class=img-responsive alt="Generate a Kubeconfig to Enable OpenShift Service Account Authentication"></a></div><div class="name same-height-always"><h5><a href=http://guifreelife.com/blog/2025/04/09/Kubeconfig-for-OpenShift-Service-Accounts/>Generate a Kubeconfig to Enable OpenShift Service Account Authentication</a></h5></div></div></div><hr class="hidden-md hidden-lg"></div><div class="col-md-4 col-sm-6"><h4>Contact</h4><p class=text-uppercase><strong>Dale Bewley</strong><br>Oakland<br>California<br><strong>USA</strong></p><a href=/contact class="btn btn-small btn-template-main">Go to contact page</a><hr class="hidden-md hidden-lg hidden-sm"></div></div></footer><div id=copyright><div class=container><div class=col-md-12><p class=pull-left>Copyright (c) 2021, Dale Bewley; all rights reserved.</p><p class=pull-right>Template by <a href=https://bootstrapious.com/p/universal-business-e-commerce-template>Bootstrapious</a>.
Ported to Hugo by <a href=https://github.com/devcows/hugo-universal-theme>DevCows</a>.</p></div></div></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-39TSW9349X"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-39TSW9349X")}</script><script src=//code.jquery.com/jquery-3.1.1.min.js integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin=anonymous></script><script src=//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/Counter-Up/1.0/jquery.counterup.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/jquery-parallax/1.1.3/jquery-parallax.js></script><script src="//maps.googleapis.com/maps/api/js?key=AIzaSyDacpwSIXi6lk2fS2wzZOSoh7iHm_ZP3UE&v=3.exp"></script><script src=/js/hpneo.gmaps.js></script><script src=/js/gmaps.init.js></script><script src=/js/front.js></script><script src=/js/owl.carousel.min.js></script></body></html>