<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta name=viewport content="width=device-width,initial-scale=1"><title>Securing Cloud-init User Data with External Secrets and OpenShift Virtualization | GUI Free Life</title><meta name=author content="Dale Bewley"><meta name=keywords content="bewley,guifreelife,1password,automation,security,openshift,kubernetes,kustomize,virtualization"><meta name=description content="Learn how to securely manage cloud-init user data in OpenShift Virtualization using External Secrets Operator and 1Password, keeping sensitive information out of git repositories."><meta name=generator content="Hugo 0.147.8"><link href='//fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,500,700,800' rel=stylesheet type=text/css><link rel=stylesheet href=//use.fontawesome.com/releases/v5.11.2/css/all.css><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link href=/css/animate.css rel=stylesheet><link href=/css/style.turquoise.css rel=stylesheet id=theme-stylesheet><link href=/css/custom.css rel=stylesheet><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel="shortcut icon" href=/img/favicon.ico type=image/x-icon><link rel=apple-touch-icon href=/img/apple-touch-icon.png><link href=/css/owl.carousel.css rel=stylesheet><link href=/css/owl.theme.css rel=stylesheet><link rel=alternate href=http://guifreelife.com/index.xml type=application/rss+xml title="GUI Free Life"><meta property="og:locale" content="en_us"><meta property="og:site_name" content="GUI Free Life"><meta property="og:title" content="Securing Cloud-init User Data with External Secrets and OpenShift Virtualization"><meta property="og:type" content="article"><meta property="og:url" content="http://guifreelife.com/blog/2025/10/06/Securing-Cloud-init-User-Data-with-External-Secrets-and-OpenShift-Virtualization/"><meta property="og:description" content="Learn how to securely manage cloud-init user data in OpenShift Virtualization using External Secrets Operator and 1Password, keeping sensitive information out of git repositories."><meta property="og:image" content="http://guifreelife.com/images/blog-external-secrets.png"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="2044"><meta property="og:updated_time" content="2025-10-06T00:00:00Z"><meta property="article:tag" content="1password"><meta property="article:tag" content="automation"><meta property="article:tag" content="security"><meta property="article:tag" content="openshift"><meta property="article:tag" content="kubernetes"><meta property="article:tag" content="kustomize"><meta property="article:tag" content="virtualization"><meta property="article:published_time" content="2025-10-06T00:00:00Z"><meta property="article:modified_time" content="2025-10-06T00:00:00Z"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Securing Cloud-init User Data with External Secrets and OpenShift …"><meta name=twitter:image content="http://guifreelife.com/images/blog-external-secrets.png"><meta name=twitter:description content="Learn how to securely manage cloud-init user data in OpenShift Virtualization using External Secrets Operator and 1Password, keeping sensitive information out of git repositories."><link rel=stylesheet type=text/css href=/css/asciinema-player.css><script src=/js/asciinema-player.js></script></head><body><div id=all><header class=navbar-affixed-top data-spy=affix data-offset-top=62><div class="navbar navbar-default yamm" role=navigation id=navbar><div class=container><div class=navbar-header><a class="navbar-brand home" href=/><img src=/img/logo.png alt="Securing Cloud-init User Data with External Secrets and OpenShift Virtualization logo" class="hidden-xs hidden-sm">
<img src=/img/logo-small.png alt="Securing Cloud-init User Data with External Secrets and OpenShift Virtualization logo" class="visible-xs visible-sm">
<span class=sr-only>Securing Cloud-init User Data with External Secrets and OpenShift Virtualization - go to homepage</span></a><div class=navbar-buttons><button type=button class="navbar-toggle btn-template-main" data-toggle=collapse data-target=#navigation>
<span class=sr-only>Toggle Navigation</span>
<i class="fas fa-align-justify"></i></button></div></div><div class="navbar-collapse collapse" id=navigation><ul class="nav navbar-nav navbar-right"><li class=dropdown><a href=/>Home</a></li><li class="dropdown active"><a href=/blog/>Blog</a></li><li class=dropdown><a href=/contact/>Contact</a></li></ul></div><div class="collapse clearfix" id=search><form class=navbar-form role=search><div class=input-group><input type=text class=form-control placeholder=Search>
<span class=input-group-btn><button type=submit class="btn btn-template-main"><i class="fas fa-search"></i></button></span></div></form></div></div></div></header><style>.bar.background-image-fixed-banner{background:url(/images/blog-external-secrets.png)50% 0 no-repeat;background-attachment:fixed;background-size:cover;padding:100px 5%;text-shadow:2px 3px 4px var(--primary-accent),0 0 1em var(--navbar-border-top)}</style><div><div class=container><div class=row><div class=col-md-12><section class="bar background-image-fixed-banner heading h2 color-white text-center"><h1>Securing Cloud-init User Data with External Secrets and OpenShift Virtualization</h1></section></div></div></div></div><div id=content><div class=container><div class=row><div class=col-md-9 id=blog-post><p class="text-muted text-uppercase mb-small text-right">October 6, 2025</p><div id=post-content><p>Storing Kubernetes resources in git for automated deployment promotes consistency, resilency, and accountability, but commiting secrets to git is risky and should be avoided. Use the External Secrets Operator to securely store cloud-init and other data, and sleep soundly!</p><h1 id=securing-cloud-init-user-data>Securing Cloud-init User Data</h1><p>As described in <a href=http://guifreelife.com/coming-soon/ title=Deploying-LDAP-AutoFS-with-OpenShift-Virtualization>this post</a> the cloud-init <code>userData</code> script for a <a href=https://www.redhat.com/en/technologies/cloud-computing/openshift/virtualization title="OpenShift Virtualization">OpenShift Virtualization</a> virtual machine may contain privileged information like activation keys for your RHEL subscription.</p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8b008b;font-weight:700>rh_subscription</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>org</span>:<span style=color:#bbb> </span><span style=color:#b452cd>00000000</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>activation-key</span>:<span style=color:#bbb> </span>EXAMPLE<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>enable-repo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#cd5555>&#39;rhel-9-for-x86_64-baseos-rpms&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#cd5555>&#39;rhel-9-for-x86_64-appstream-rpms&#39;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>These example userData scripts for VMs: <a href=https://github.com/dlbewley/demo-autofs/blob/main/client/base/scripts/userData title="Client VM cloud-init">client</a>, <a href=https://github.com/dlbewley/demo-autofs/blob/main/ldap/base/scripts/userData title="LDAP VM cloud-init">ldap</a>, and <a href=https://github.com/dlbewley/demo-autofs/blob/main/nfs/base/scripts/userData title="NFS VM cloud-init">nfs</a> have placeholders which make them safe to place in a public repository.</p><p>Most of the data isn&rsquo;t sensitive, and keeping the scripts in git makes for easier testing and debugging. But how can we safely manage the actual secret to be used by cloud-init if it is not commited to git?</p><h1 id=the-external-secrets-operator>The External Secrets Operator</h1><p>The <a href=https://external-secrets.io/latest/ title="External Secrets Operator">External Secrets Operator</a> solves this issue for us by understanding how to look into secure vaults from &ldquo;<a href=https://external-secrets.io/latest/provider/1password-sdk/ title="1Password ESO Provider">providers</a>&rdquo; like AWS Secrets Manager, HashiCorp Vault, or 1Password.</p><p>Once your data is within a secure vault, you will create an <code>ExternalSecret</code> resource, which is safe to commit to git. When you apply these resources to the cluster, the ESO will use the information in the ExternalSecret to create a Kubernetes <code>Secret</code> resource, securely downloading, and inserting the sensitive data into it.</p><h2 id=1password-provider-for-eso>1Password Provider for ESO</h2><p>Using <a href=https://1password.com>1Password</a> can be handy in a homelab or development environment, particularly if you already use 1Password to manage credentials in your browser. You Don&rsquo;t have to deploy any infrastructure or have an AWS account to use it. Be aware there is more than one 1Password integration and you should select the 1Password-SDK External Secrets Operator provider.</p><h2 id=installing-the-external-secrets-operator>Installing the External Secrets Operator</h2><p>Make sure to install a version of the External Secrets Operator (ESO) that supports the 1password-sdk provider, which was introduced in version 0.17. The older 1password-connect provider is now deprecated. If the operator has been updated to version 0.17 or later by the time you read this, you may be able to use the operator directly instead of installing via the Helm chart.</p><p>Install latest upstream ESO using Helm.</p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ helm repo add external-secrets https://charts.external-secrets.io
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ oc new-project external-secrets
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ helm install external-secrets <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>   external-secrets/external-secrets <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>   -n external-secrets
</span></span></code></pre></div><h1 id=configuring-1password>Configuring 1Password</h1><p>Use the command line to setup 1Password. Grab the 1Password CLI command <code>op</code> from <a href=https://developer.1password.com/>https://developer.1password.com/</a> or use <code>brew</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ brew install 1password-cli
</span></span></code></pre></div><p>Create a dedicated vault in 1Password for use by the ESO, so there is no chance of your personal data sloshing around in your Kubernetes environment.</p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ op vault create eso --icon gears
</span></span></code></pre></div><p>Create a token to authenticate the ESO to access 1Password. Note that 90 days is the max lifetime allowed by 1Password.</p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#00688b>TOKEN</span>=<span style=color:#8b008b;font-weight:700>$(</span>
</span></span><span style=display:flex><span>    op service-account create external-secrets-operator <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>      --expires-in 90d <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>      --vault eso:read_items,write_items <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>    <span style=color:#8b008b;font-weight:700>)</span>
</span></span></code></pre></div><p>Place this token in a secret called <em>onepassword-connect-token</em> which allows ESO to authenticate to 1Password.</p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc create secret generic onepassword-connect-token <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span> --from-literal=<span style=color:#00688b>token</span>=<span style=color:#cd5555>&#34;</span><span style=color:#00688b>$TOKEN</span><span style=color:#cd5555>&#34;</span> <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span> -n external-secrets
</span></span></code></pre></div><blockquote><p>⭐ <strong>Pro Tip:</strong>
Test the token to confirm access to the vault items by setting the <code>OP_SERVICE_ACCOUNT_TOKEN</code> environment variable.</p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> $ <span style=color:#658b00>export</span> <span style=color:#00688b>OP_SERVICE_ACCOUNT_TOKEN</span>=<span style=color:#8b008b;font-weight:700>$(</span>oc extract secret/onepassword-connect-token <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>  -n external-secrets --keys=token --to=-<span style=color:#8b008b;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> $ op item list --vault eso
</span></span><span style=display:flex><span> ID                            TITLE                            VAULT            EDITED
</span></span><span style=display:flex><span> yzsurcc4oxfjp7qdidonudn3ne    demo autofs ldap                 eso              <span style=color:#b452cd>22</span> hours ago
</span></span><span style=display:flex><span> wretasduq3rkip7wn37njozghi    demo autofs nfs                  eso              <span style=color:#b452cd>22</span> hours ago
</span></span><span style=display:flex><span> euaujb4izjftqineetzaer3x7i    demo autofs client               eso              <span style=color:#b452cd>5</span> days ago
</span></span></code></pre></div></blockquote><h2 id=uploading-userdata-to-the-vault>Uploading userData to the Vault</h2><p>Now, we can take the example userData files and modify them to contain the sensitive data we want. In this case, the organization ID and activation key required for our subscription.</p><p>Edit the checked out copy of the <code>{VM}/base/scripts/userData</code> scripts, and insert the configuration that should not be stored in git.</p><p>At this point, the copies in your working directory may now look like the following. Be certain not to commit these changes to git!</p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8b008b;font-weight:700>rh_subscription</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>org</span>:<span style=color:#bbb> </span><span style=color:#b452cd>12345678</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>activation-key</span>:<span style=color:#bbb> </span>secret-key4me<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>enable-repo</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#cd5555>&#39;rhel-9-for-x86_64-baseos-rpms&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- <span style=color:#cd5555>&#39;rhel-9-for-x86_64-appstream-rpms&#39;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Now <a href=https://developer.1password.com/docs/cli/item-create/ title="1Password Create Item Docs">create 1Password items</a> storing the modified <code>userData</code> for each VM.</p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#00688b>vault</span>=eso
</span></span><span style=display:flex><span><span style=color:#8b008b;font-weight:700>for</span> vm in client ldap nfs; <span style=color:#8b008b;font-weight:700>do</span>
</span></span><span style=display:flex><span>  op item create <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>    --vault <span style=color:#cd5555>&#34;</span><span style=color:#00688b>$vault</span><span style=color:#cd5555>&#34;</span> <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>    --category login <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>    --title <span style=color:#cd5555>&#34;demo autofs </span><span style=color:#00688b>$vm</span><span style=color:#cd5555>&#34;</span> <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>    --url <span style=color:#cd5555>&#34;https://github.com/dlbewley/demo-autofs/tree/main/</span><span style=color:#cd5555>${</span><span style=color:#00688b>vm</span><span style=color:#cd5555>}</span><span style=color:#cd5555>/base/scripts&#34;</span> <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>    --tags <span style=color:#00688b>demo</span>=autofs <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>    <span style=color:#cd5555>&#34;userData[file]=</span><span style=color:#cd5555>${</span><span style=color:#00688b>vm</span><span style=color:#cd5555>}</span><span style=color:#cd5555>/base/scripts/userData&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8b008b;font-weight:700>done</span>
</span></span></code></pre></div><blockquote><p>📓 If you later make changes to the userData script you can update the copy in 1Password like this.</p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#00688b>vault</span>=eso
</span></span><span style=display:flex><span><span style=color:#8b008b;font-weight:700>for</span> vm in client ldap nfs; <span style=color:#8b008b;font-weight:700>do</span>
</span></span><span style=display:flex><span>  op item edit <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>    --vault <span style=color:#cd5555>&#34;</span><span style=color:#00688b>$vault</span><span style=color:#cd5555>&#34;</span> <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>    --url <span style=color:#cd5555>&#34;https://github.com/dlbewley/demo-autofs/tree/main/</span><span style=color:#cd5555>${</span><span style=color:#00688b>vm</span><span style=color:#cd5555>}</span><span style=color:#cd5555>/base/scripts&#34;</span> <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>    <span style=color:#cd5555>&#34;demo autofs </span><span style=color:#00688b>$vm</span><span style=color:#cd5555>&#34;</span> <span style=color:#cd5555>\
</span></span></span><span style=display:flex><span><span style=color:#cd5555></span>    <span style=color:#cd5555>&#34;userData[file]=</span><span style=color:#cd5555>${</span><span style=color:#00688b>vm</span><span style=color:#cd5555>}</span><span style=color:#cd5555>/base/scripts/userData&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8b008b;font-weight:700>done</span>
</span></span></code></pre></div></blockquote><p>Here is a view of the 1Password vault after uploading each of our <code>userData</code> scripts.</p><figure><a href=/images/securing-cloud-init-1password-vault.png><img src=/images/securing-cloud-init-1password-vault.png alt="1Password Vault Entry" width=100%></a><figcaption><p>1Password Vault Entry</p></figcaption></figure><h1 id=configuring-the-external-secrets-operator>Configuring the External Secrets Operator</h1><p>Now that 1Password is ready, it&rsquo;s time to tell the ESO about it.</p><p>Create a <code>ClusterSecretStore</code> associated to the 1password-sdk provider. This will be referenced by <code>ExternalSecret</code> resources created later, and it will use the secret token we just created to look up data in the vault.</p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#008b45;text-decoration:underline>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>external-secrets.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterSecretStore<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>1password-sdk<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>provider</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>onepasswordSDK</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>vault</span>:<span style=color:#bbb> </span>eso<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#bbb>      </span><span style=color:#8b008b;font-weight:700>auth</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex;background-color:#d6d6c6><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#bbb>        </span><span style=color:#8b008b;font-weight:700>serviceAccountSecretRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex;background-color:#d6d6c6><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#bbb>          </span><span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>onepassword-connect-token<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#bbb>          </span><span style=color:#8b008b;font-weight:700>key</span>:<span style=color:#bbb> </span>token<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#bbb>          </span><span style=color:#8b008b;font-weight:700>namespace</span>:<span style=color:#bbb> </span>external-secrets<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=reading-secret-data-from-the-vault>Reading Secret Data from the Vault</h2><p>Create an <code>externalsecret.yaml</code> for each VM.
Here are examples for each of the VMs <a href=https://github.com/dlbewley/demo-autofs/blob/main/client/base/externalsecret.yaml title="Client VM ExternalSecret">client</a>, <a href=https://github.com/dlbewley/demo-autofs/blob/main/ldap/base/externalsecret.yaml title="LDAP VM ExternalSecret">ldap</a>, and <a href=https://github.com/dlbewley/demo-autofs/blob/main/nfs/base/externalsecret.yaml title="NFS VM ExternalSecret">nfs</a>.</p><p>Notice below that we set the refreshInterval to 0 so that the ESO is not continually checking 1Password for changes to this secret. Remember this secret is only used once, when the VM boots for the first time.</p><p>If you do not disable this refresh, then it is likely that you will become rate limited.</p><blockquote><span class=expand><span class=expand-label style=cursor:pointer onclick='$h=$(this),$h.next("div").slideToggle(200,function(){$h.children("i").attr("class",function(){return $h.next("div").is(":visible")?"fas fa-chevron-down":"fas fa-chevron-right"})})'>🔐 <strong>External Secret</strong>
<i class="fas fa-chevron-down"></i></span><div class=expand-content style="display:block;margin:10px 0"><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#008b45;text-decoration:underline>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>external-secrets.io/v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>kind</span>:<span style=color:#bbb> </span>ExternalSecret<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>metadata</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>cloudinitdisk-client<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>spec</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>refreshPolicy</span>:<span style=color:#bbb> </span>OnChange<span style=color:#bbb>
</span></span></span><span style=display:flex;background-color:#d6d6c6><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>refreshInterval</span>:<span style=color:#bbb> </span><span style=color:#cd5555>&#34;0&#34;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>secretStoreRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterSecretStore<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>1password-sdk<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>target</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex;background-color:#d6d6c6><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>cloudinitdisk-client<span style=color:#bbb> </span><span style=color:#228b22># this will be the name of the created secret</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>creationPolicy</span>:<span style=color:#bbb> </span>Owner<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>data</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#bbb></span>- <span style=color:#8b008b;font-weight:700>secretKey</span>:<span style=color:#bbb> </span><span style=color:#cd5555>&#34;userData&#34;</span><span style=color:#bbb> </span><span style=color:#228b22># this will be a field in the secret</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>remoteRef</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#bbb>    </span><span style=color:#228b22># 1password-entry-name and property</span><span style=color:#bbb>
</span></span></span><span style=display:flex;background-color:#d6d6c6><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>key</span>:<span style=color:#bbb> </span><span style=color:#cd5555>&#34;demo autofs client/userData&#34;</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></span></blockquote><p>This <code>ExternalSecret</code> will retrieve the data at &ldquo;demo autofs client/userData&rdquo; create a Secret named <code>cloudinitdisk-client</code>.</p><h1 id=updating-the-vm-deployment>Updating the VM Deployment</h1><p>Now we must update <a href=https://github.com/dlbewley/demo-autofs/blob/main/client/base/kustomization.yaml title="Client VM Kustomization">the kustomization.yaml</a> file that deploys the virtual machine. It should create the <code>ExternalSecret</code> and patch the VM to mount the subsequently created <code>Secret</code> holding the sensitive version of the cloud-init script.</p><p>As a reference, we can still let Kustomize generate a sample secret from our &ldquo;clean&rdquo; userData in git.</p><blockquote><span class=expand><span class=expand-label style=cursor:pointer onclick='$h=$(this),$h.next("div").slideToggle(200,function(){$h.children("i").attr("class",function(){return $h.next("div").is(":visible")?"fas fa-chevron-down":"fas fa-chevron-right"})})'>🪡 <strong>Virtual Machine Patches</strong>
<i class="fas fa-chevron-down"></i></span><div class=expand-content style="display:block;margin:10px 0"><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#008b45;text-decoration:underline>---</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kustomize.config.k8s.io/v1beta1<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>kind</span>:<span style=color:#bbb> </span>Kustomization<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>namespace</span>:<span style=color:#bbb> </span>demo-client<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>labels</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#bbb></span>- <span style=color:#8b008b;font-weight:700>includeSelectors</span>:<span style=color:#bbb> </span><span style=color:#8b008b;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>pairs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>demo</span>:<span style=color:#bbb> </span>client<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>app.kubernetes.io/instance</span>:<span style=color:#bbb> </span>demo-autofs-client<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>components</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#bbb></span>- ../../components/argocd-vm-management<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>generatorOptions</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>disableNameSuffixHash</span>:<span style=color:#bbb> </span><span style=color:#8b008b;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>configMapGenerator</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#bbb></span>- <span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>sssd-conf<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>files</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#bbb>    </span>- scripts/sssd.conf<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#bbb>    </span>- scripts/homedir.conf<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>secretGenerator</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex;background-color:#d6d6c6><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#bbb></span>- <span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>cloudinitdisk-client-sample<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>files</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#bbb>    </span>- scripts/userData<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>resources</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#bbb></span>- namespace.yaml<span style=color:#bbb>
</span></span></span><span style=display:flex;background-color:#d6d6c6><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#bbb></span>- externalsecret.yaml<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#bbb></span>- virtualmachine.yaml<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#bbb></span><span style=color:#8b008b;font-weight:700>patches</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#bbb></span>- <span style=color:#8b008b;font-weight:700>target</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>group</span>:<span style=color:#bbb> </span>kubevirt.io<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>kind</span>:<span style=color:#bbb> </span>VirtualMachine<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>name</span>:<span style=color:#bbb> </span>.*<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#bbb>    </span><span style=color:#8b008b;font-weight:700>version</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#bbb>  </span><span style=color:#8b008b;font-weight:700>patch</span>:<span style=color:#bbb> </span>|-<span style=color:#cd5555>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#cd5555>    - op: replace
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#cd5555>      path: /spec/runStrategy
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span><span style=color:#cd5555>      value: Always
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span><span style=color:#cd5555>    # add volumes for secret and configmap
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span><span style=color:#cd5555>    - op: replace
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span><span style=color:#cd5555>      path: /spec/template/spec/volumes/1/cloudInitNoCloud
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span><span style=color:#cd5555>      value: {
</span></span></span><span style=display:flex;background-color:#d6d6c6><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span><span style=color:#cd5555>        &#34;secretRef&#34;: {
</span></span></span><span style=display:flex;background-color:#d6d6c6><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span><span style=color:#cd5555>          &#34;name&#34;: &#34;cloudinitdisk-client&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span><span style=color:#cd5555>        }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span><span style=color:#cd5555>      }</span><span style=color:#bbb>
</span></span></span></code></pre></div></div></span></blockquote><h1 id=booting-the-vm>Booting the VM</h1><p>Finally, deploy the Virtual Machine using <a href=https://kustomize.io/ title=Kustomize>Kustomize</a> via the <code>oc apply -k</code> command.</p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc apply -k client/overlays/localnet
</span></span><span style=display:flex><span>namespace/demo-client created
</span></span><span style=display:flex><span>role.rbac.authorization.k8s.io/argocd-vm-management created
</span></span><span style=display:flex><span>rolebinding.rbac.authorization.k8s.io/argocd-vm-management created
</span></span><span style=display:flex><span>configmap/sssd-conf created
</span></span><span style=display:flex><span>secret/cloudinitdisk-client-sample created
</span></span><span style=display:flex><span>externalsecret.external-secrets.io/cloudinitdisk-client created <span style=color:#228b22># &lt;---</span>
</span></span><span style=display:flex><span>virtualmachine.kubevirt.io/client created
</span></span></code></pre></div><p>After a moment, the <code>ExternalSecret</code> status should be <em>SecretSynced</em> and we can see that the resulting <code>cloudinitdisk-client</code> secret has been created.</p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ oc get externalsecrets -n demo-client
</span></span><span style=display:flex><span>NAME                   STORETYPE            STORE           REFRESH INTERVAL   STATUS         READY
</span></span><span style=display:flex><span>cloudinitdisk-client   ClusterSecretStore   1password-sdk   <span style=color:#b452cd>0</span>                  SecretSynced   True
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ oc get secrets -l <span style=color:#00688b>demo</span>=client -n demo-client
</span></span><span style=display:flex><span>NAME                          TYPE     DATA   AGE
</span></span><span style=display:flex><span>cloudinitdisk-client          Opaque   <span style=color:#b452cd>1</span>      98s   <span style=color:#228b22># Created by ESO</span>
</span></span><span style=display:flex><span>cloudinitdisk-client-sample   Opaque   <span style=color:#b452cd>1</span>      2m20s <span style=color:#228b22># Generated by Kustomize</span>
</span></span></code></pre></div><p>Once the VM boots we can login and examine the user data imported from the secret, and confirm the information from the vault is indeed there!</p><div class=highlight><pre tabindex=0 style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[root@client ~]<span style=color:#228b22># grep -A2 subscription /var/lib/cloud/instance/user-data.txt</span>
</span></span><span style=display:flex><span>rh_subscription:
</span></span><span style=display:flex><span>  org: <span style=color:#b452cd>12345678</span>
</span></span><span style=display:flex><span>  activation-key: secret-key4me
</span></span></code></pre></div><h1 id=summary>Summary</h1><p>By leveraging the <a href=https://external-secrets.io/latest/ title="External Secrets Operator">External Secrets Operator</a> and <a href=https://kustomize.io/ title=Kustomize>Kustomize</a> we <em>safely</em> deployed fully provisioned Virtual Machines to OpenShift using a single command.
We used 1Password for it&rsquo;s ubiquity and ease of setup, but this pattern can be adapted for other secret backends and VM configurations, providing a robust solution for secret management in <a href=https://www.redhat.com/en/technologies/cloud-computing/openshift/virtualization title="OpenShift Virtualization">OpenShift Virtualization</a> environments.</p><h1 id=references>References</h1><ul><li><a href=https://github.com/dlbewley/demo-autofs/ title="Demo Github Repo">Demo Github Repo</a></li><li><a href=https://github.com/dlbewley/demo-autofs/blob/main/client/base/externalsecret.yaml title="Client userData External Secret">Client userData External Secret</a></li><li><a href=https://external-secrets.io/latest/ title="External Secrets Operator">External Secrets Operator</a></li><li><a href=https://external-secrets.io/latest/provider/1password-sdk/ title="1Password ESO Provider">1Password-SDK ESO Provider</a></li><li><a href=https://developer.1password.com/docs/cli/item-create/ title="1Password Create Item Docs">1Password Create Item Docs</a></li><li><a href=https://kustomize.io/ title=Kustomize>Kustomize</a></li><li><a href=https://www.redhat.com/en/technologies/cloud-computing/openshift/virtualization title="OpenShift Virtualization">OpenShift Virtualization</a></li></ul></div><script type=application/javascript src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script><script>var config={startOnLoad:!0,theme:"base",align:"center"};mermaid.initialize(config)</script></div><div class=col-md-3><div class="panel panel-default sidebar-menu"><div class=panel-heading><h3 class=panel-title>Search</h3></div><div class=panel-body><form action=//google.com/search method=get accept-charset=UTF-8 role=search><div class=input-group><input type=search name=q class=form-control placeholder=Search>
<input type=hidden name=sitesearch value=http://guifreelife.com/>
<span class=input-group-btn><button type=submit class="btn btn-template-main"><i class="fas fa-search"></i></button></span></div></form></div></div><div class="panel sidebar-menu"><div class=panel-heading><h3 class=panel-title>Tagged</h3></div><div class=panel-body><ul class=tag-cloud><li class=active><a href=/tags/1password><i class="fas fa-tags"></i> 1password</a></li><li class=active><a href=/tags/automation><i class="fas fa-tags"></i> automation</a></li><li class=active><a href=/tags/security><i class="fas fa-tags"></i> security</a></li><li class=active><a href=/tags/openshift><i class="fas fa-tags"></i> openshift</a></li><li class=active><a href=/tags/kubernetes><i class="fas fa-tags"></i> kubernetes</a></li><li class=active><a href=/tags/kustomize><i class="fas fa-tags"></i> kustomize</a></li><li class=active><a href=/tags/virtualization><i class="fas fa-tags"></i> virtualization</a></li></ul></div></div><div class="panel sidebar-menu"><div class=panel-heading><h3 class=panel-title>TOC</h3></div><div class=panel-body><nav id=TableOfContents><ul><li><a href=#securing-cloud-init-user-data>Securing Cloud-init User Data</a></li><li><a href=#the-external-secrets-operator>The External Secrets Operator</a><ul><li><a href=#1password-provider-for-eso>1Password Provider for ESO</a></li><li><a href=#installing-the-external-secrets-operator>Installing the External Secrets Operator</a></li></ul></li><li><a href=#configuring-1password>Configuring 1Password</a><ul><li><a href=#uploading-userdata-to-the-vault>Uploading userData to the Vault</a></li></ul></li><li><a href=#configuring-the-external-secrets-operator>Configuring the External Secrets Operator</a><ul><li><a href=#reading-secret-data-from-the-vault>Reading Secret Data from the Vault</a></li></ul></li><li><a href=#updating-the-vm-deployment>Updating the VM Deployment</a></li><li><a href=#booting-the-vm>Booting the VM</a></li><li><a href=#summary>Summary</a></li><li><a href=#references>References</a></li></ul></nav></div></div><div class="panel sidebar-menu"><div class=panel-heading><h3 class=panel-title>Tags</h3></div><div class=panel-body><ul class=tag-cloud><li><a href=/tags/1password><i class="fas fa-tags"></i> 1password</a></li><li><a href=/tags/ansible><i class="fas fa-tags"></i> ansible</a></li><li><a href=/tags/automation><i class="fas fa-tags"></i> automation</a></li><li><a href=/tags/aws><i class="fas fa-tags"></i> aws</a></li><li><a href=/tags/azure><i class="fas fa-tags"></i> azure</a></li><li><a href=/tags/cdk><i class="fas fa-tags"></i> cdk</a></li><li><a href=/tags/coreos><i class="fas fa-tags"></i> coreos</a></li><li><a href=/tags/debugging><i class="fas fa-tags"></i> debugging</a></li><li><a href=/tags/docker><i class="fas fa-tags"></i> docker</a></li><li><a href=/tags/draft><i class="fas fa-tags"></i> draft</a></li><li><a href=/tags/etcd><i class="fas fa-tags"></i> etcd</a></li><li><a href=/tags/git><i class="fas fa-tags"></i> git</a></li><li><a href=/tags/haproxy><i class="fas fa-tags"></i> haproxy</a></li><li><a href=/tags/heat><i class="fas fa-tags"></i> heat</a></li><li><a href=/tags/hybrid-cloud><i class="fas fa-tags"></i> hybrid-cloud</a></li><li><a href=/tags/install><i class="fas fa-tags"></i> install</a></li><li><a href=/tags/kubeconfig><i class="fas fa-tags"></i> kubeconfig</a></li><li><a href=/tags/kubernetes><i class="fas fa-tags"></i> kubernetes</a></li><li><a href=/tags/kustomize><i class="fas fa-tags"></i> kustomize</a></li><li><a href=/tags/mac><i class="fas fa-tags"></i> mac</a></li><li><a href=/tags/metrics><i class="fas fa-tags"></i> metrics</a></li><li><a href=/tags/migration><i class="fas fa-tags"></i> migration</a></li><li><a href=/tags/monitoring><i class="fas fa-tags"></i> monitoring</a></li><li><a href=/tags/networking><i class="fas fa-tags"></i> networking</a></li><li><a href=/tags/ocp3><i class="fas fa-tags"></i> ocp3</a></li><li><a href=/tags/ocp4><i class="fas fa-tags"></i> ocp4</a></li><li><a href=/tags/openshift><i class="fas fa-tags"></i> openshift</a></li><li><a href=/tags/openstack><i class="fas fa-tags"></i> openstack</a></li><li><a href=/tags/operators><i class="fas fa-tags"></i> operators</a></li><li><a href=/tags/prometheus><i class="fas fa-tags"></i> prometheus</a></li><li><a href=/tags/python><i class="fas fa-tags"></i> python</a></li><li><a href=/tags/rhacm><i class="fas fa-tags"></i> rhacm</a></li><li><a href=/tags/rhacs><i class="fas fa-tags"></i> rhacs</a></li><li><a href=/tags/rhel><i class="fas fa-tags"></i> rhel</a></li><li><a href=/tags/router><i class="fas fa-tags"></i> router</a></li><li><a href=/tags/security><i class="fas fa-tags"></i> security</a></li><li><a href=/tags/ssl><i class="fas fa-tags"></i> ssl</a></li><li><a href=/tags/stackrox><i class="fas fa-tags"></i> stackrox</a></li><li><a href=/tags/storage><i class="fas fa-tags"></i> storage</a></li><li><a href=/tags/troubleshooting><i class="fas fa-tags"></i> troubleshooting</a></li><li><a href=/tags/upgrade><i class="fas fa-tags"></i> upgrade</a></li><li><a href=/tags/vagrant><i class="fas fa-tags"></i> vagrant</a></li><li><a href=/tags/virtualization><i class="fas fa-tags"></i> virtualization</a></li><li><a href=/tags/webinar><i class="fas fa-tags"></i> webinar</a></li><li><a href=/tags/windows><i class="fas fa-tags"></i> windows</a></li><li><a href=/tags/zabbix><i class="fas fa-tags"></i> zabbix</a></li><li><a href=/tags/zimbra><i class="fas fa-tags"></i> zimbra</a></li></ul></div></div></div></div></div></div><footer id=footer><div class=container><div class="col-md-4 col-sm-6"><h4>Share</h4><i class="fab fa-2x fa-twitter" title="Share this on Twitter" onclick='window.open("http://twitter.com/home?status=http://guifreelife.com/blog/2025/10/06/Securing-Cloud-init-User-Data-with-External-Secrets-and-OpenShift-Virtualization/")'></i>
<i class="fab fa-2x fa-facebook" title="Share this on Facebook" onclick='window.open("http://www.facebook.com/share.php?u=http://guifreelife.com/blog/2025/10/06/Securing-Cloud-init-User-Data-with-External-Secrets-and-OpenShift-Virtualization/")'></i>
<i class="fab fa-2x fa-linkedin" title="Share this on Linkedin" onclick='window.open("https://www.linkedin.com/shareArticle?mini=true&url=http://guifreelife.com/blog/2025/10/06/Securing-Cloud-init-User-Data-with-External-Secrets-and-OpenShift-Virtualization/&title=&summary=&source=")'></i>
<i class="fab fa-2x fa-google-plus" title="Share this on Google Currents" onclick='window.open("https://plus.google.com/share?url=http://guifreelife.com/blog/2025/10/06/Securing-Cloud-init-User-Data-with-External-Secrets-and-OpenShift-Virtualization/")'></i>
<i class="fa fa-2x fa-envelope" title="Share this through Email" onclick='window.open("mailto:?&body=http://guifreelife.com/blog/2025/10/06/Securing-Cloud-init-User-Data-with-External-Secrets-and-OpenShift-Virtualization/")'></i><h4>About us</h4><p>GUI Free Life is the personal, technical blog of Dale Bewley. Comments and opinions are my own and not that of my employers.</p><hr class="hidden-md hidden-lg hidden-sm"></div><div class="col-md-4 col-sm-6"><h4>Recent posts</h4><div class=blog-entries><div class="item same-height-row clearfix"><div class="image same-height-always"><a href=http://guifreelife.com/blog/2025/10/06/Securing-Cloud-init-User-Data-with-External-Secrets-and-OpenShift-Virtualization/><img src=/images/blog-external-secrets.png class=img-responsive alt="Securing Cloud-init User Data with External Secrets and OpenShift Virtualization"></a></div><div class="name same-height-always"><h5><a href=http://guifreelife.com/blog/2025/10/06/Securing-Cloud-init-User-Data-with-External-Secrets-and-OpenShift-Virtualization/>Securing Cloud-init User Data with External Secrets and OpenShift Virtualization</a></h5></div></div><div class="item same-height-row clearfix"><div class="image same-height-always"><a href=http://guifreelife.com/blog/2025/06/20/CoreOS-Image-Layering-Autofs/><img src=/images/layering-cake-trans.png class=img-responsive alt="OpenShift CoreOS On-Cluster Custom Node Image Layering"></a></div><div class="name same-height-always"><h5><a href=http://guifreelife.com/blog/2025/06/20/CoreOS-Image-Layering-Autofs/>OpenShift CoreOS On-Cluster Custom Node Image Layering</a></h5></div></div><div class="item same-height-row clearfix"><div class="image same-height-always"><a href=http://guifreelife.com/blog/2025/05/29/Managing-OpenShift-Machine-Configuration-with-Butane-and-Ignition/><img src=/images/machineconfigs-butane.png class=img-responsive alt="Managing Readable OpenShift MachineConfigs with Butane"></a></div><div class="name same-height-always"><h5><a href=http://guifreelife.com/blog/2025/05/29/Managing-OpenShift-Machine-Configuration-with-Butane-and-Ignition/>Managing Readable OpenShift MachineConfigs with Butane</a></h5></div></div></div><hr class="hidden-md hidden-lg"></div><div class="col-md-4 col-sm-6"><h4>Contact</h4><p class=text-uppercase><strong>Dale Bewley</strong><br>Oakland<br>California<br><strong>USA</strong></p><a href=/contact class="btn btn-small btn-template-main">Go to contact page</a><hr class="hidden-md hidden-lg hidden-sm"></div></div></footer><div id=copyright><div class=container><div class=col-md-12><p class=pull-left>Copyright (c) 2021, Dale Bewley; all rights reserved.</p><p class=pull-right>Template by <a href=https://bootstrapious.com/p/universal-business-e-commerce-template>Bootstrapious</a>.
Ported to Hugo by <a href=https://github.com/devcows/hugo-universal-theme>DevCows</a>.</p></div></div></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-39TSW9349X"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-39TSW9349X")}</script><script src=//code.jquery.com/jquery-3.1.1.min.js integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin=anonymous></script><script src=//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/Counter-Up/1.0/jquery.counterup.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/jquery-parallax/1.1.3/jquery-parallax.js></script><script src="//maps.googleapis.com/maps/api/js?key=AIzaSyDacpwSIXi6lk2fS2wzZOSoh7iHm_ZP3UE&v=3.exp"></script><script src=/js/hpneo.gmaps.js></script><script src=/js/gmaps.init.js></script><script src=/js/front.js></script><script src=/js/owl.carousel.min.js></script></body></html>