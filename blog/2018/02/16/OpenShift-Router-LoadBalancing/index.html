<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta name=viewport content="width=device-width,initial-scale=1"><title>Load balancing of OpenShift HA Routers Mind the GARP</title><meta name=author content="DevCows"><meta name=keywords content="devows,hugo,go,kubernetes,openshift,networking"><meta name=description content="Site template made by devcows using hugo"><meta name=generator content="Hugo 0.81.0"><link href="//fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,500,700,800" rel=stylesheet type=text/css><link rel=stylesheet href=//use.fontawesome.com/releases/v5.11.2/css/all.css><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link href=/css/animate.css rel=stylesheet><link href=/css/style.turquoise.css rel=stylesheet id=theme-stylesheet><link href=/css/custom.css rel=stylesheet><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel="shortcut icon" href=/img/favicon.ico type=image/x-icon><link rel=apple-touch-icon href=/img/apple-touch-icon.png><link href=/css/owl.carousel.css rel=stylesheet><link href=/css/owl.theme.css rel=stylesheet><link rel=alternate href=https://dwnwrd.github.io/index.xml type=application/rss+xml title="dwnwrd Universal"><meta property="og:locale" content="en_us"><meta property="og:site_name" content="dwnwrd Universal"><meta property="og:title" content="Load balancing of OpenShift HA Routers Mind the GARP"><meta property="og:type" content="article"><meta property="og:url" content="https://dwnwrd.github.io/blog/2018/02/16/OpenShift-Router-LoadBalancing/"><meta property="og:description" content="Site template made by devcows using hugo"><meta property="og:image" content="https://dwnwrd.github.io/images/openshift-routing-garp-before.png"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content="1208"><meta property="og:image:height" content="414"><meta property="og:updated_time" content="2018-02-16T00:00:00Z"><meta property="article:tag" content="kubernetes"><meta property="article:tag" content="openshift"><meta property="article:tag" content="networking"><meta property="article:published_time" content="2018-02-16T00:00:00Z"><meta property="article:modified_time" content="2018-02-16T00:00:00Z"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@dlbewley"><meta name=twitter:title content="Load balancing of OpenShift HA Routers Mind the GARP"><meta name=twitter:image content="https://dwnwrd.github.io/images/openshift-routing-garp-before.png"><meta name=twitter:description content="Site template made by devcows using hugo"></head><body><div id=all><header class=navbar-affixed-top data-spy=affix data-offset-top=62><div class="navbar navbar-default yamm" role=navigation id=navbar><div class=container><div class=navbar-header><a class="navbar-brand home" href=/><img src=/img/logo.png alt="Load balancing of OpenShift HA Routers Mind the GARP logo" class="hidden-xs hidden-sm">
<img src=/img/logo-small.png alt="Load balancing of OpenShift HA Routers Mind the GARP logo" class="visible-xs visible-sm">
<span class=sr-only>Load balancing of OpenShift HA Routers Mind the GARP - go to homepage</span></a><div class=navbar-buttons><button type=button class="navbar-toggle btn-template-main" data-toggle=collapse data-target=#navigation>
<span class=sr-only>Toggle Navigation</span>
<i class="fas fa-align-justify"></i></button></div></div><div class="navbar-collapse collapse" id=navigation><ul class="nav navbar-nav navbar-right"><li class=dropdown><a href=/>Home</a></li><li class="dropdown active"><a href=/blog/>Blog</a></li><li class=dropdown><a href=/contact/>Contact</a></li></ul></div><div class="collapse clearfix" id=search><form class=navbar-form role=search><div class=input-group><input type=text class=form-control placeholder=Search>
<span class=input-group-btn><button type=submit class="btn btn-template-main"><i class="fas fa-search"></i></button></span></div></form></div></div></div></header><div id=heading-breadcrumbs><div class=container><div class=row><div class=col-md-12><h1>Load balancing of OpenShift HA Routers Mind the GARP</h1></div></div></div></div><div id=content><div class=container><div class=row><div class=col-md-9 id=blog-post><p class="text-muted text-uppercase mb-small text-right">February 16, 2018</p><div id=post-content><p><a href=http://guifreelife.com/blog/2016/03/01/OpenShift-3-HA-Routing>OpenShift HA Routing</a> uses <a href=https://docs.openshift.com/container-platform/latest/architecture/networking/haproxy-router.html>haproxy application routers</a> to get traffic into the cluster. These application routers are made redundant by running <a href=https://docs.openshift.com/container-platform/latest/admin_guide/high_availability.html>ipfailover (keepalived)</a> pods to maintain a set of Virtual IPs on each infrastructure node where the application routers run. These VIPs are then referenced by round robin DNS records to enable a measure of load balancing.</p><p>OK, so now you are load balancing at the network layer, but what about the link layer?
Did you know that even <em>if</em> you somehow manage to perfectly balance traffic among the VIPs using RR DNS you could still be using only one of your application routers? Well you could be!</p><p><a href=/images/openshift-routing-garp-before.png><img src=/images/openshift-routing-garp-before.png alt="Bandwidth to Infra Nodes"></a></p><p><strong>Example Environment</strong></p><p>Here is an environment with 3 infrastructure nodes and and 3 primary or applications nodes in the 192.0.2.0/24 address space. The application domain is <code>os.example.com</code>.</p><p>The 3 infrastucture nodes participate in the HA routing by running ipfailover pods that implement keepalived to keep IPs 192.0.2.101-103 alive. Along side those ipfailover pods an haproxy pod binds to each IP.</p><p>The DNS response for lookups in <code>*.os.example.com</code> will look like this. The order of the addresses in the response should be varied by the DNS server.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ dig +short foo.os.example.com
192.0.2.103
192.0.2.101
192.0.2.102
</code></pre></div><p>Now looking deeper into the network interface on the nodes, let&rsquo;s enumerate the MAC address and the IP addresses on <code>eth0</code>:</p><ul><li><strong>Infra Node 1</strong></li></ul><pre><code>[root@ose-prod-node-01 ~]# ethtool -P eth0
Permanent address: 00:1a:4a:48:BE:4B

[root@ose-prod-node-01 ~]# ip -4 -o a show eth0
2: eth0    inet 192.0.2.1/24 brd 192.0.2.255 scope global dynamic eth0\       valid_lft 62345sec preferred_lft 62345sec
2: eth0    inet 192.0.2.102/32 scope global eth0\       valid_lft forever preferred_lft forever
2: eth0    inet 192.0.2.101/32 scope global eth0\       valid_lft forever preferred_lft forever
2: eth0    inet 192.0.2.103/32 scope global eth0\       valid_lft forever preferred_lft forever
</code></pre><ul><li><strong>Infra Node 2</strong></li></ul><pre><code>[root@ose-prod-node-02 ~]# ethtool -P eth0
Permanent address: 00:1a:4a:48:BE:EF

[root@ose-prod-node-02 ~]# ip -4 -o a show eth0
2: eth0    inet 192.0.2.2/24 brd 192.0.2.255 scope global dynamic eth0\       valid_lft 72864sec preferred_lft 72864sec
2: eth0    inet 192.0.2.103/32 scope global eth0\       valid_lft forever preferred_lft forever
2: eth0    inet 192.0.2.101/32 scope global eth0\       valid_lft forever preferred_lft forever
2: eth0    inet 192.0.2.102/32 scope global eth0\       valid_lft forever preferred_lft forever
</code></pre><ul><li><strong>Infra Node 3</strong></li></ul><pre><code>[root@ose-prod-node-03 ~]# ethtool -P eth0
Permanent address: 00:1a:4a:48:BE:4C

[root@ose-prod-node-03 ~]# ip -4 -o a show eth0
2: eth0    inet 192.0.2.3/24 brd 192.0.2.255 scope global dynamic eth0\       valid_lft 81509sec preferred_lft 81509sec
2: eth0    inet 192.0.2.101/32 scope global eth0\       valid_lft forever preferred_lft forever
2: eth0    inet 192.0.2.102/32 scope global eth0\       valid_lft forever preferred_lft forever
2: eth0    inet 192.0.2.103/32 scope global eth0\       valid_lft forever preferred_lft forever
</code></pre><p><strong>Node Summary</strong></p><table><thead><tr><th>Node</th><th>Eth0 MAC</th><th>Eth0 IPs</th></tr></thead><tbody><tr><td>ose-prod-node-01</td><td>00:1a:4a:48:<strong>BE:4B</strong></td><td><strong>192.0.2.1</strong>, 192.0.2.101, 192.0.2.102, 192.0.2.103</td></tr><tr><td>ose-prod-node-02</td><td>00:1a:4a:48:<strong>BE:EF</strong></td><td><strong>192.0.2.2</strong>, 192.0.2.101, 192.0.2.102, 192.0.2.103</td></tr><tr><td>ose-prod-node-03</td><td>00:1a:4a:48:<strong>BE:4C</strong></td><td><strong>192.0.2.3</strong>, 192.0.2.101, 192.0.2.102, 192.0.2.103</td></tr></tbody></table><p><strong>Client Traffic</strong></p><p>Web browsers will look up the IP address for <code>app.os.example.com</code> and will get back three <code>A</code> records (<em>192.0.2.101, 192.0.2.102, 192.0.2.103</em>) in the response.
The DNS server will shuffle the order of the IPs in the response and the client will typically choose the first IP in the list to connect to.</p><p>All three of these IPs are always available even if only one node is alive and the client has no idea which node is serving its traffic.</p><p>Keep in mind it is the network router attached to the nodes that will decide how to relay the packet from the client to those 3 IP addresses. Also remember that ultimately the packet will be sent to a MAC address, not an IP address.
How? Adress resolution protocol. Since the router is on the same layer 2 segment as these VIPs it will maintain a ARP table that maps IP addresses to MAC addresses.
Over time, or after some event like a network split or node reboots the ARP table could wind up thwarting your efforts to balance the traffic.</p><p><strong>Network Router</strong></p><p>Let&rsquo;s check the ARP table on the router to see where traffic will be sent at the link layer.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>core<span style=color:#f92672>(</span>s1<span style=color:#f92672>)</span><span style=color:#75715e># sh ip arp 192.0.2.101</span>
Address         Age <span style=color:#f92672>(</span>min<span style=color:#f92672>)</span>  Hardware Addr   Interface
192.0.2.101          <span style=color:#ae81ff>0</span>  001a.4a48.BE4B  Vlan176, Port-Channel391

core<span style=color:#f92672>(</span>s1<span style=color:#f92672>)</span><span style=color:#75715e># sh ip arp 192.0.2.102</span>
Address         Age <span style=color:#f92672>(</span>min<span style=color:#f92672>)</span>  Hardware Addr   Interface
192.0.2.102          <span style=color:#ae81ff>0</span>  001a.4a48.BE4C  Vlan176, Port-Channel391

core<span style=color:#f92672>(</span>s1<span style=color:#f92672>)</span><span style=color:#75715e># sh ip arp 192.0.2.103</span>
Address         Age <span style=color:#f92672>(</span>min<span style=color:#f92672>)</span>  Hardware Addr   Interface
192.0.2.103          <span style=color:#ae81ff>0</span>  001a.4a48.BE4C  Vlan176, Port-Channel391
</code></pre></div><p>You can see that IP address 192.0.2.101 is known to the router by MAC (Hardware) address <code>001a.4a48.BE4B</code> which is <code>eth0</code> on Node 1.</p><p>However, both addresses 192.0.2.102 and 192.0.2.103 are known to the router by the same MAC address <code>001a.4a48.BE4C</code> with is <code>eth0</code> on Node 3.</p><p><strong>Router Summary</strong></p><table><thead><tr><th>Router ARP Table</th><th>IP</th><th>MAC Address</th></tr></thead><tbody><tr><td>192.0.2.101</td><td>00:1a:4a:48:<strong>BE:4B</strong></td><td></td></tr><tr><td>192.0.2.102</td><td>00:1a:4a:48:<strong>BE:4C</strong></td><td></td></tr><tr><td>192.0.2.103</td><td>00:1a:4a:48:<strong>BE:4C</strong></td><td></td></tr></tbody></table><p>This means that any time the network router is sending traffic to those 3 IPs it will always send it nodes 1 and 3. Node 2 will never get any traffic for those VIPs. Things could likely be worse. You might have all 3 IPs associated with the same IP address. Go look now!</p><h1 id=the-fix>The Fix</h1><p>So how do you fix that? GARP. A gratuitous ARP from the node can inform the router, <em>&ldquo;Hey! I am MAC X:X and I answer to IP Y.Y. Remember that!"</em> and the router will do as it is told and update it&rsquo;s ARP table.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ssh root@ose-prod-node-01 arping -c <span style=color:#ae81ff>4</span> -A -I eth0 192.0.2.101
ssh root@ose-prod-node-02 arping -c <span style=color:#ae81ff>4</span> -A -I eth0 192.0.2.102
ssh root@ose-prod-node-03 arping -c <span style=color:#ae81ff>4</span> -A -I eth0 192.0.2.103
</code></pre></div><p><a href=/images/openshift-routing-garp-after.png><img src=/images/openshift-routing-garp-after.png alt="Bandwidth to Infra Nodes After GARP"></a></p><p><strong>The Caveat</strong></p><p>Of course if one of the nodes were to reboot it&rsquo;s MAC address would become unreachable, it would fall out of the router ARP table, the router would send an ARP request and another MAC address would fill in and do double duty. Things will stay like that indefinitely.</p><p>One approach would be to perform the above arping on a regular basis or after maintenance events that take down infrastructure nodes.</p><p><em>Mind the GARP!</em></p></div><div id=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//dlbewleygithubio.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><div class=col-md-3><div class="panel panel-default sidebar-menu"><div class=panel-heading><h3 class=panel-title>Search</h3></div><div class=panel-body><form action=//google.com/search method=get accept-charset=utf-8 role=search><div class=input-group><input type=search name=q class=form-control placeholder=Search>
<input type=hidden name=sitesearch value=https://dwnwrd.github.io/>
<span class=input-group-btn><button type=submit class="btn btn-template-main"><i class="fas fa-search"></i></button></span></div></form></div></div><div class="panel sidebar-menu"><div class=panel-heading><h3 class=panel-title>Tagged</h3></div><div class=panel-body><ul class=tag-cloud><li class=active><a href=/tags/kubernetes><i class="fas fa-tags"></i>kubernetes</a></li><li class=active><a href=/tags/openshift><i class="fas fa-tags"></i>openshift</a></li><li class=active><a href=/tags/networking><i class="fas fa-tags"></i>networking</a></li></ul></div></div><div class="panel sidebar-menu"><div class=panel-heading><h3 class=panel-title>Tags</h3></div><div class=panel-body><ul class=tag-cloud><li><a href=/tags/CDK><i class="fas fa-tags"></i>CDK</a></li><li><a href=/tags/OCP3><i class="fas fa-tags"></i>OCP3</a></li><li><a href=/tags/OCP4><i class="fas fa-tags"></i>OCP4</a></li><li><a href=/tags/OSE3><i class="fas fa-tags"></i>OSE3</a></li><li><a href=/tags/RHEL><i class="fas fa-tags"></i>RHEL</a></li><li><a href=/tags/ansible><i class="fas fa-tags"></i>ansible</a></li><li><a href=/tags/automation><i class="fas fa-tags"></i>automation</a></li><li><a href=/tags/docker><i class="fas fa-tags"></i>docker</a></li><li><a href=/tags/draft><i class="fas fa-tags"></i>draft</a></li><li><a href=/tags/etcd><i class="fas fa-tags"></i>etcd</a></li><li><a href=/tags/git><i class="fas fa-tags"></i>git</a></li><li><a href=/tags/haproxy><i class="fas fa-tags"></i>haproxy</a></li><li><a href=/tags/heat><i class="fas fa-tags"></i>heat</a></li><li><a href=/tags/install><i class="fas fa-tags"></i>install</a></li><li><a href=/tags/kubernetes><i class="fas fa-tags"></i>kubernetes</a></li><li><a href=/tags/mac><i class="fas fa-tags"></i>mac</a></li><li><a href=/tags/metrics><i class="fas fa-tags"></i>metrics</a></li><li><a href=/tags/migration><i class="fas fa-tags"></i>migration</a></li><li><a href=/tags/monitoring><i class="fas fa-tags"></i>monitoring</a></li><li><a href=/tags/networking><i class="fas fa-tags"></i>networking</a></li><li><a href=/tags/openshift><i class="fas fa-tags"></i>openshift</a></li><li><a href=/tags/openstack><i class="fas fa-tags"></i>openstack</a></li><li><a href=/tags/operators><i class="fas fa-tags"></i>operators</a></li><li><a href=/tags/python><i class="fas fa-tags"></i>python</a></li><li><a href=/tags/router><i class="fas fa-tags"></i>router</a></li><li><a href=/tags/ssl><i class="fas fa-tags"></i>ssl</a></li><li><a href=/tags/troubleshooting><i class="fas fa-tags"></i>troubleshooting</a></li><li><a href=/tags/upgrade><i class="fas fa-tags"></i>upgrade</a></li><li><a href=/tags/vagrant><i class="fas fa-tags"></i>vagrant</a></li><li><a href=/tags/zabbix><i class="fas fa-tags"></i>zabbix</a></li><li><a href=/tags/zimbra><i class="fas fa-tags"></i>zimbra</a></li></ul></div></div></div></div></div></div><footer id=footer><div class=container><div class="col-md-4 col-sm-6"><h4>About us</h4><p>GUI Free Life is the personal, technical blog of Dale Bewley. Comments and opinions are my own and not that of my employers.</p><hr class="hidden-md hidden-lg hidden-sm"></div><div class="col-md-4 col-sm-6"><h4>Recent posts</h4><div class=blog-entries><div class="item same-height-row clearfix"><div class="image same-height-always"><a href=https://dwnwrd.github.io/blog/2021/03/09/Understanding-OpenShift-Over-The-Air-Updates/><img src=/images/the-face-of-a-computer-operator-from-the-2134th-communications-squadron-is-2ca9c9.jpg class=img-responsive alt="How do OpenShift Over The Air Updates Work?"></a></div><div class="name same-height-always"><h5><a href=https://dwnwrd.github.io/blog/2021/03/09/Understanding-OpenShift-Over-The-Air-Updates/>How do OpenShift Over The Air Updates Work?</a></h5></div></div><div class="item same-height-row clearfix"><div class="image same-height-always"><a href=https://dwnwrd.github.io/blog/2020/02/15/OpenShift-4-on-OpenStack-Networking-and-Installation/><img src=/images/openshift-openstack-install-network-00.png class=img-responsive alt="OpenShift 4 on OpenStack Networking and Installation"></a></div><div class="name same-height-always"><h5><a href=https://dwnwrd.github.io/blog/2020/02/15/OpenShift-4-on-OpenStack-Networking-and-Installation/>OpenShift 4 on OpenStack Networking and Installation</a></h5></div></div><div class="item same-height-row clearfix"><div class="image same-height-always"><a href=https://dwnwrd.github.io/blog/2019/05/09/Replace-Bootstrap-Kubeconfig/><img src=/img/banners/banner-5.jpg class=img-responsive alt="Playbook to replace bootstrap.kubeconfig and node certificates on OpenShift 3.10 3.11"></a></div><div class="name same-height-always"><h5><a href=https://dwnwrd.github.io/blog/2019/05/09/Replace-Bootstrap-Kubeconfig/>Playbook to replace bootstrap.kubeconfig and node certificates on OpenShift 3.10 3.11</a></h5></div></div></div><hr class="hidden-md hidden-lg"></div><div class="col-md-4 col-sm-6"><h4>Contact</h4><p class=text-uppercase><strong>Dale Bewley</strong><br>Oakland<br>California<br><strong>USA</strong></p><a href=/contact class="btn btn-small btn-template-main">Go to contact page</a><hr class="hidden-md hidden-lg hidden-sm"></div></div></footer><div id=copyright><div class=container><div class=col-md-12><p class=pull-left>Copyright (c) 2021, Dale Bewley; all rights reserved.</p><p class=pull-right>Template by <a href=https://bootstrapious.com/p/universal-business-e-commerce-template>Bootstrapious</a>.
Ported to Hugo by <a href=https://github.com/devcows/hugo-universal-theme>DevCows</a>.</p></div></div></div></div><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-78084690-1','auto'),ga('send','pageview'))</script><script src=//code.jquery.com/jquery-3.1.1.min.js integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin=anonymous></script><script src=//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/Counter-Up/1.0/jquery.counterup.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/jquery-parallax/1.1.3/jquery-parallax.js></script><script src="//maps.googleapis.com/maps/api/js?key=AIzaSyDacpwSIXi6lk2fS2wzZOSoh7iHm_ZP3UE&v=3.exp"></script><script src=/js/hpneo.gmaps.js></script><script src=/js/gmaps.init.js></script><script src=/js/front.js></script><script src=/js/owl.carousel.min.js></script></body></html>